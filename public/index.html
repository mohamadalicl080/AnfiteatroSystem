<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anfiteatro Registro</title>
  
  <!-- Modal Ticket / Resumen Movimiento -->
  <div id="movementTicketModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-overlay flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="gradient-bg text-white p-6 rounded-t-2xl">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-2xl font-bold"><i class="fas fa-receipt mr-2"></i>Detalle del Movimiento</h3>
            <p class="text-sm text-purple-200 mt-1">Resumen tipo ticket</p>
          </div>
          <button type="button" onclick="closeTicketModal()" class="text-white hover:text-gray-200 text-2xl"><i class="fas fa-times"></i></button>
        </div>
      </div>

      <div class="p-6">
        <div class="bg-gray-50 border border-gray-200 rounded-xl p-5">
          <div id="ticketContent" class="space-y-4"></div>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="ui-fixes.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    * { font-family: 'Inter', sans-serif; }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-card-green { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-card-orange { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .stat-card-purple { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
    input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; filter: invert(0.5); }
    .notification-badge { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .tab-active { border-bottom: 3px solid #667eea; color: #667eea; font-weight: 600; }
    .modal-overlay { backdrop-filter: blur(4px); }
  </style>
</head>

<body class="bg-gray-50">
  <nav class="gradient-bg text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-4">
          <i class="fas fa-building text-2xl"></i>
          <div>
            <h1 class="text-xl font-bold">Anfiteatro Registro</h1>
            <p class="text-xs text-purple-200">Sistema de Gesti√≥n Comercial</p>
          </div>
        </div>
	        <div class="flex items-center space-x-6">
	          <div class="relative">
	            <!-- Bot√≥n campana: clickable completo. El badge NO debe bloquear el click. -->
	            <button id="navBellBtn" type="button" class="relative inline-flex items-center justify-center w-10 h-10 focus:outline-none" title="Ver alertas">
	              <i class="fas fa-bell text-xl"></i>
	              <span id="navAlertasBadge" class="pointer-events-none absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center notification-badge hidden">0</span>
	            </button>
	          </div>
          <div class="flex items-center space-x-2">
  <img id="userAvatar" src="https://ui-avatars.com/api/?name=Usuario&background=fff&color=667eea" class="h-8 w-8 rounded-full" alt="User">
  <div class="text-sm">
    <p id="userName" class="font-semibold">Usuario</p>
    <p id="userRoleLabel" class="text-xs text-purple-200">Rol</p>
  </div>
  <button id="logoutBtn" type="button" class="ml-2 text-purple-100 hover:text-white" title="Salir">
    <i class="fas fa-right-from-bracket"></i>
  </button>
</div>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
      <div class="stat-card rounded-xl p-6 text-white card-hover cursor-pointer">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-sm opacity-90">Ingresos Mes</p>
            <h3 class="text-3xl font-bold mt-2"><span id="cardIngresosMes">$0</span></h3>
            <p id="cardIngresosMesLine" class="text-xs mt-2 opacity-75">‚Äî</p>
          </div>
          <i class="fas fa-arrow-trend-up text-3xl opacity-50"></i>
        </div>
      </div>

      <div class="stat-card-green rounded-xl p-6 text-white card-hover cursor-pointer">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-sm opacity-90">Egresos Mes</p>
            <h3 class="text-3xl font-bold mt-2"><span id="cardEgresosMes">$0</span></h3>
            <p id="cardEgresosMesLine" class="text-xs mt-2 opacity-75">‚Äî</p>
          </div>
          <i class="fas fa-arrow-trend-down text-3xl opacity-50"></i>
        </div>
      </div>

      <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl p-6 text-white card-hover cursor-pointer shadow-lg">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-sm opacity-90">Balance Total</p>
            <h3 class="text-3xl font-bold mt-2"><span id="cardBalanceTotal">$0</span></h3>
            <p class="text-xs mt-2 opacity-75"><i class="fas fa-arrow-up mr-1"></i><span id="cardIngresosTotal">$0</span> ingresos</p>
            <p class="text-xs opacity-75"><i class="fas fa-arrow-down mr-1"></i><span id="cardEgresosTotal">$0</span> egresos</p>
          </div>
          <i class="fas fa-chart-line text-3xl opacity-50"></i>
        </div>
      </div>

      <div class="stat-card-orange rounded-xl p-6 text-white card-hover cursor-pointer">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-sm opacity-90">Morosos</p>
            <h3 class="text-3xl font-bold mt-2"><span id="cardMorosos">0</span></h3>
            <p id="cardMorososLine" class="text-xs mt-2 opacity-75">‚Äî</p>
          </div>
          <i class="fas fa-exclamation-triangle text-3xl opacity-50"></i>
        </div>
      </div>

      <div class="stat-card-purple rounded-xl p-6 text-gray-800 card-hover cursor-pointer">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-sm opacity-90">Caja Chica</p>
            <h3 class="text-3xl font-bold mt-2"><span id="cardCajaChica">$0</span></h3>
            <p class="text-xs mt-2 opacity-75">Saldo disponible</p>
          </div>
          <i class="fas fa-wallet text-3xl opacity-50"></i>
        </div>
      </div>
    </div>

    <!-- Tabs bar -->
    <div class="bg-white rounded-t-xl shadow-sm border-b">
      <div class="flex space-x-8 px-6 overflow-x-auto">
        <button class="tabs-btn py-4 tab-active whitespace-nowrap" data-tab="movimientos">
          <i class="fas fa-exchange-alt mr-2"></i>Movimientos
        </button>
        <button class="tabs-btn py-4 text-gray-600 hover:text-purple-600 whitespace-nowrap" data-tab="gastos">
          <i class="fas fa-receipt mr-2"></i>Gastos Comunes
        </button>
        <button class="tabs-btn py-4 text-gray-600 hover:text-purple-600 whitespace-nowrap" data-tab="arriendos">
          <i class="fas fa-home mr-2"></i>Arriendos
        </button>
        <button class="tabs-btn py-4 text-gray-600 hover:text-purple-600 whitespace-nowrap" data-tab="proveedores">
          <i class="fas fa-tools mr-2"></i>Proveedores
        </button>
        <button class="tabs-btn py-4 text-gray-600 hover:text-purple-600 whitespace-nowrap" data-tab="empleados">
          <i class="fas fa-users mr-2"></i>Empleados
        </button>
        <button class="tabs-btn py-4 text-gray-600 hover:text-purple-600 whitespace-nowrap" data-tab="caja-chica">
          <i class="fas fa-wallet mr-2"></i>Caja Chica
        </button>
        <button class="tabs-btn py-4 text-gray-600 hover:text-purple-600 whitespace-nowrap" data-tab="otros">
          <i class="fas fa-folder mr-2"></i>Otros
        </button>
        <button class="tabs-btn py-4 text-gray-600 hover:text-purple-600 whitespace-nowrap" data-tab="alertas">
          <i class="fas fa-bell mr-2"></i>Alertas
          <span id="tabAlertasBadge" class="ml-1 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
        </button>
        <button class="tabs-btn py-4 text-gray-600 hover:text-purple-600 whitespace-nowrap" data-tab="resumen">
          <i class="fas fa-chart-pie mr-2"></i>Resumen Mensual
        </button>
        <button class="tabs-btn py-4 text-gray-600 hover:text-purple-600 whitespace-nowrap" data-tab="actividad">
          <i class="fas fa-history mr-2"></i>Registro Actividad
          <span class="ml-1 bg-purple-500 text-white text-xs px-2 py-0.5 rounded-full">Admin</span>
        </button>
      </div>
    </div>

    <!-- Movimientos -->
    <div id="movimientos-tab" class="bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-list-ul mr-2 text-purple-600"></i>Movimientos Recientes</h2>
        <div class="flex space-x-3">
          <button onclick="openNewMovementModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2.5 rounded-lg font-semibold shadow-md transition duration-200 flex items-center">
            <i class="fas fa-plus mr-2"></i>Nuevo Movimiento
          </button>
          <button id="printSelectedButton" type="button" class="bg-white border border-gray-300 text-gray-700 px-6 py-2.5 rounded-lg font-semibold shadow-md transition duration-200 flex items-center opacity-50 cursor-not-allowed" disabled>
            <i class="fas fa-print mr-2"></i>Imprimir
            <span id="printSelectedCount" class="ml-2 inline-flex items-center justify-center text-xs font-bold bg-purple-100 text-purple-700 rounded-full px-2 py-0.5 hidden">0</span>
          </button>
          <button id="exportButton" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2.5 rounded-lg font-semibold shadow-md transition duration-200 flex items-center">
            <i class="fas fa-download mr-2"></i>Exportar
            <span class="ml-2 text-xs bg-green-800 px-2 py-0.5 rounded-full">Admin</span>
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">√Årea</label>
          <select id="filterArea" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <option>Todas las √°reas</option>
            <option>Gastos Comunes</option>
            <option>Arriendos</option>
            <option>Proveedores</option>
            <option>Empleados</option>
            <option>Caja Chica</option>
            <option>Otros</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
          <select id="filterTipo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <option>Todos</option>
            <option>Ingreso</option>
            <option>Egreso</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Desde</label>
          <input id="filterDesde" type="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Hasta</label>
          <input id="filterHasta" type="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-3 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                <input id="movSelectAll" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
              </th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fecha</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">√Årea</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tipo</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Descripci√≥n</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Monto</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Responsable</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="movimientosBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>

      <div class="flex justify-between items-center mt-6">
        <p id="movimientosInfo" class="text-sm text-gray-600">Mostrando 0-0 de 0 movimientos</p>
        <div id="movimientosPagination" class="flex space-x-2"></div>
      </div>
    </div>

    <!-- Gastos -->
    <div id="gastos-tab" class="hidden bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-receipt mr-2 text-purple-600"></i>Gastos Comunes</h2>
        <div class="text-sm text-gray-600">Movimientos: <span id="gastosCount" class="font-semibold">0</span> ¬∑ Total: <span id="gastosTotal" class="font-semibold">$0</span></div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fecha</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tipo</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Descripci√≥n</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Monto</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Responsable</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="gastosBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <!-- Arriendos -->
    <div id="arriendos-tab" class="hidden bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-home mr-2 text-purple-600"></i>Arriendos</h2>
        <div class="text-sm text-gray-600">Movimientos: <span id="arriendosCount" class="font-semibold">0</span> ¬∑ Total: <span id="arriendosTotal" class="font-semibold">$0</span></div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fecha</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tipo</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Descripci√≥n</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Monto</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Responsable</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="arriendosBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <!-- Proveedores -->
    <div id="proveedores-tab" class="hidden bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-tools mr-2 text-purple-600"></i>Proveedores</h2>
        <div class="text-sm text-gray-600">Movimientos: <span id="proveedoresCount" class="font-semibold">0</span> ¬∑ Total: <span id="proveedoresTotal" class="font-semibold">$0</span></div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fecha</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tipo</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Descripci√≥n</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Monto</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Responsable</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="proveedoresBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <!-- Empleados -->
    <div id="empleados-tab" class="hidden bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-users mr-2 text-purple-600"></i>Empleados</h2>
        <div class="text-sm text-gray-600">Movimientos: <span id="empleadosCount" class="font-semibold">0</span> ¬∑ Total: <span id="empleadosTotal" class="font-semibold">$0</span></div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fecha</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tipo</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Descripci√≥n</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Monto</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Responsable</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="empleadosBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <!-- Caja chica -->
    <div id="caja-chica-tab" class="hidden bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-wallet mr-2 text-purple-600"></i>Caja Chica</h2>
        <div class="text-sm text-gray-600">Movimientos: <span id="cajaChicaCount" class="font-semibold">0</span> ¬∑ Neto: <span id="cajaChicaTotal" class="font-semibold">$0</span></div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fecha</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tipo</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Descripci√≥n</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Monto</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Responsable</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="cajaChicaBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <!-- Otros -->
    <div id="otros-tab" class="hidden bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-folder mr-2 text-purple-600"></i>Otros</h2>
        <div class="text-sm text-gray-600">Movimientos: <span id="otrosCount" class="font-semibold">0</span> ¬∑ Total: <span id="otrosTotal" class="font-semibold">$0</span></div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fecha</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tipo</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Descripci√≥n</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Monto</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Responsable</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="otrosBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <!-- Alertas -->
    <div id="alertas-tab" class="hidden bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-bell mr-2 text-purple-600"></i>Alertas</h2>
        <div class="text-sm text-gray-600">Activas: <span id="alertasCount" class="font-semibold">0</span></div>
      </div>
      <div id="alertasList" class="space-y-3"></div>
      <p class="text-xs text-gray-400 mt-4">*Las alertas se generan desde Movimientos (morosos/pendientes y egresos altos).</p>
    </div>

    <!-- Resumen -->
    <div id="resumen-tab" class="hidden bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-chart-pie mr-2 text-purple-600"></i>Resumen Mensual</h2>
        <div class="text-sm text-gray-600">Mes: <span id="resumenMes" class="font-semibold">‚Äî</span></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="p-4 rounded-lg bg-gray-50 border">
          <div class="text-xs text-gray-500">Ingresos (mes)</div>
          <div id="resumenIngresosMes" class="text-xl font-semibold">$0</div>
        </div>
        <div class="p-4 rounded-lg bg-gray-50 border">
          <div class="text-xs text-gray-500">Egresos (mes)</div>
          <div id="resumenEgresosMes" class="text-xl font-semibold">$0</div>
        </div>
        <div class="p-4 rounded-lg bg-gray-50 border">
          <div class="text-xs text-gray-500">Balance (mes)</div>
          <div id="resumenBalanceMes" class="text-xl font-semibold">$0</div>
        </div>
      </div>

      <h3 class="font-semibold text-gray-700 mb-2">Top √°reas (mes)</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">√Årea</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Ingresos</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Egresos</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Neto</th>
            </tr>
          </thead>
          <tbody id="resumenTopAreas" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <!-- Actividad -->
    <div id="actividad-tab" class="hidden bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-history mr-2 text-purple-600"></i>Registro Actividad</h2>
        <div class="text-sm text-gray-600">Solo Admin ¬∑ √öltimas acciones</div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fecha/Hora</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Usuario</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Acci√≥n</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Detalle</th>
            </tr>
          </thead>
          <tbody id="actividadBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>

      <!-- Paginaci√≥n (10 por p√°gina) -->
      <div class="flex justify-between items-center mt-4">
        <div id="actividadInfo" class="text-sm text-gray-500"></div>
        <div class="flex items-center space-x-2">
          <button id="actividadPrev" type="button" class="px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed">Anterior</button>
          <span id="actividadPageBadge" class="px-3 py-2 rounded-lg text-sm bg-purple-100 text-purple-700 font-semibold">1</span>
          <button id="actividadNext" type="button" class="px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed">Siguiente</button>
        </div>
      </div>

      <p class="text-xs text-gray-400 mt-4">Actividades de usuarios.</p>
    </div>

  </div> <!-- /container -->

  <!-- Modal -->
  <div id="newMovementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-overlay flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="gradient-bg text-white p-6 rounded-t-2xl">
        <div class="flex justify-between items-center">
          <div>
            <h3 id="modalTitle" class="text-2xl font-bold">Nuevo Movimiento</h3>
            <p class="text-sm text-purple-200 mt-1">Registra un nuevo movimiento financiero</p>
          </div>
          <button onclick="closeModal()" class="text-white hover:text-gray-200 text-2xl"><i class="fas fa-times"></i></button>
        </div>
      </div>

      <form class="p-6 space-y-4" id="movementForm">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-calendar text-purple-600 mr-2"></i>Fecha del Movimiento</label>
          <input id="mvFecha" type="date" value="2026-02-06" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200" required>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-layer-group text-purple-600 mr-2"></i>√Årea</label>
          <select id="mvArea" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200" required>
            <option value="">Seleccione un √°rea...</option>
            <option value="gastos-comunes">üí° Gastos Comunes</option>
            <option value="arriendos">üè† Arriendos</option>
            <option value="proveedores">üîß Proveedores</option>
            <option value="empleados">üë• Empleados</option>
            <option value="caja-chica">üí∞ Caja Chica</option>
            <option value="otros">üìã Otros</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-exchange-alt text-purple-600 mr-2"></i>Tipo de Movimiento</label>
          <div class="grid grid-cols-2 gap-4">
            <label class="relative">
              <input id="mvTipoIngreso" type="radio" name="tipo" value="ingreso" class="peer sr-only" required>
              <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer peer-checked:border-green-500 peer-checked:bg-green-50 transition duration-200">
                <div class="flex items-center space-x-3">
                  <i class="fas fa-arrow-up text-2xl text-green-600"></i>
                  <div><p class="font-semibold text-gray-800">Ingreso</p><p class="text-xs text-gray-500">Entrada de dinero</p></div>
                </div>
              </div>
            </label>
            <label class="relative">
              <input id="mvTipoEgreso" type="radio" name="tipo" value="egreso" class="peer sr-only" required>
              <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer peer-checked:border-red-500 peer-checked:bg-red-50 transition duration-200">
                <div class="flex items-center space-x-3">
                  <i class="fas fa-arrow-down text-2xl text-red-600"></i>
                  <div><p class="font-semibold text-gray-800">Egreso</p><p class="text-xs text-gray-500">Salida de dinero</p></div>
                </div>
              </div>
            </label>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-dollar-sign text-purple-600 mr-2"></i>Monto</label>
          <div class="relative">
            <span class="absolute left-4 top-3.5 text-gray-500 font-semibold">$</span>
            <input id="mvMonto" type="number" placeholder="0" class="w-full pl-8 pr-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200" required>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-align-left text-purple-600 mr-2"></i>Descripci√≥n</label>
          <textarea id="mvDescripcion" rows="3" placeholder="Ej: Pago arriendo Local 12 - Febrero 2026" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200" required></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">üìÖ Per√≠odo Correspondiente</label>
          <input id="mvPeriodo" type="month" value="2026-02" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
        </div>

        <!-- ‚úÖ Estado de Pago -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Estado de Pago</label>
          <select id="mvEstadoPago" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200">
            <option value="">Seleccione...</option>
            <option>Pendiente</option>
            <option>Pagado</option>
            <option>Atrasado</option>
            <option>Anulado</option>
          </select>
        </div>

        <!-- ‚úÖ Detalles adicionales (RESTAURADO) -->
        <div class="pt-2">
          <h4 class="text-sm font-bold text-gray-700 flex items-center gap-2">
            <i class="fas fa-clipboard-list text-purple-600"></i>Detalles adicionales
          </h4>
          <p class="text-xs text-gray-500 mt-1">Completa solo lo que aplique (seg√∫n el tipo de movimiento).</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Local</label>
            <input id="mvLocal" type="text" placeholder="Ej: Local 12"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Empleado</label>
            <input id="mvEmpleado" type="text" placeholder="Ej: Juan P√©rez"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Arrendatario / Propietario</label>
            <input id="mvArrendatarioPropietario" type="text" placeholder="Ej: Pedro Soto / Inmobiliaria X"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Proveedor / Empresa</label>
            <input id="mvProveedorEmpresa" type="text" placeholder="Ej: Chilectra / Proveedor ABC"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">RUT</label>
            <input id="mvRut" type="text" placeholder="Ej: 12.345.678-9"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">M√©todo de pago</label>
            <select id="mvMetodoPago"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200">
              <option value="">Seleccione...</option>
              <option>Efectivo</option>
              <option>Transferencia</option>
              <option>Tarjeta</option>
              <option>Cheque</option>
              <option>Otro</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Fecha vencimiento</label>
            <input id="mvFechaVencimiento" type="date"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">N√∫mero comprobante</label>
            <input id="mvNumeroComprobante" type="text" placeholder="Ej: 000123"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200">
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Concepto</label>
            <input id="mvConcepto" type="text" placeholder="Ej: Arriendo / Luz / Sueldo / Mantenci√≥n"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200">
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Notas</label>
            <textarea id="mvNotas" rows="3" placeholder="Observaciones internas..."
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200"></textarea>
          </div>
        </div>

        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
          <div class="flex items-center space-x-2">
            <i class="fas fa-user-check text-purple-600"></i>
            <p class="text-sm text-gray-700"><span class="font-semibold">Responsable:</span> <span class="text-purple-600">Admin (asignado autom√°ticamente)</span></p>
          </div>
        </div>

        <div class="flex space-x-3 pt-4">
          <button type="button" onclick="closeModal()" class="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition duration-200">
            <i class="fas fa-times mr-2"></i>Cancelar
          </button>
          <button id="modalSubmitBtn" type="submit" class="flex-1 px-6 py-3 gradient-bg text-white rounded-lg font-semibold hover:shadow-lg transition duration-200">
            <i class="fas fa-save mr-2"></i><span id="modalSubmitText">Guardar Movimiento</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentUser = null;
    let authToken = localStorage.getItem("anf_token") || "";

    function getStoredUser() {
      try { return JSON.parse(localStorage.getItem("anf_user") || "null"); } catch { return null; }
    }
    function setStoredAuth(token, user) {
      if (token) localStorage.setItem("anf_token", token);
      if (user) localStorage.setItem("anf_user", JSON.stringify(user));
      authToken = token || authToken;
      currentUser = user || currentUser;
    }
    function clearAuth() {
      localStorage.removeItem("anf_token");
      localStorage.removeItem("anf_user");
      authToken = "";
      currentUser = null;
    }


    const MOV = { header: [], rows: [], idx: null };
    // Paginaci√≥n (solo pesta√±a Movimientos)
    const MOV_PAG = { pageSize: 5, page: 1, totalPages: 1, ordered: [] }; // ordered: √∫ltimos primero
    let EDITING_ID = null;

    // Tabs
    const TAB_IDS = [
      "movimientos","gastos","arriendos","proveedores","empleados",
      "caja-chica","otros","alertas","resumen","actividad"
    ];
    let CURRENT_TAB = "movimientos";

    // Actividad (persistida en Sheet)
    const ACT_LOCAL = []; // fallback: {ts,user,action,detail,movimientoId}
    const ACT = { header: [], rows: [], idx: null, loadedAt: 0 };
    const ACT_PAG = { pageSize: 10, page: 1, totalPages: 1, totalItems: 0 };

    function buildActIdx(header) {
      return {
        id: findCol(header, ["ID"]),
        fechaHora: findCol(header, ["FechaHora","Fecha/Hora","Fecha Hora"]),
        usuario: findCol(header, ["Usuario"]),
        rol: findCol(header, ["Rol"]),
        accion: findCol(header, ["Acci√≥n","Accion"]),
        descripcion: findCol(header, ["Descripci√≥n","Descripcion","Detalle"]),
        movimientoId: findCol(header, ["MovimientoID","MovimientoId","Movimiento ID"]),
      };
    }

    async function loadActividad({ force = false } = {}) {
      const now = Date.now();
      if (!force && ACT.loadedAt && (now - ACT.loadedAt) < 15000) return; // 15s cache
      try {
        const data = await apiFetch("/.netlify/functions/actividad");
        ACT.header = data.header || [];
        ACT.rows = data.rows || [];
        ACT.idx = buildActIdx(ACT.header);
        ACT.loadedAt = now;
      } catch (e) {
        console.warn("No pude cargar actividad remota:", e);
      }
    }

    function logAction(action, detail, movimientoId = "") {
      const ts = new Date().toISOString();

      // siempre mostrar lo m√°s reciente
      ACT_PAG.page = 1;

      // fallback local (por si falla la red)
      ACT_LOCAL.unshift({
        ts,
        user: currentUser?.name || "Admin",
        action,
        detail: detail || "",
        movimientoId: movimientoId || ""
      });
      if (ACT_LOCAL.length > 200) ACT_LOCAL.length = 200;

      // persistir en Sheet (no bloquea UI)
      apiFetch("/.netlify/functions/actividad", {
        method: "POST",
        body: JSON.stringify({
          usuario: currentUser?.name || "Admin",
          rol: currentUser?.role || "admin",
          accion: action,
          descripcion: detail || "",
          movimientoId: movimientoId || "",
          estado: "OK",
          dispositivo: navigator.userAgent || ""
        })
      }).then(() => {
        // refrescar cache pronto
        ACT.loadedAt = 0;
        if (CURRENT_TAB === "actividad") renderActividad();
      }).catch(err => {
        console.warn("No pude guardar actividad:", err);
      });

      if (CURRENT_TAB === "actividad") renderActividad();
    }

    function renderActividad() {
      const tbody = document.getElementById("actividadBody");
      if (!tbody) return;

      // carga remota y luego pinta
      loadActividad().then(() => {
        tbody.innerHTML = "";

        const idx = ACT.idx;
        const rowsNewestFirst = (ACT.rows || []).slice().reverse(); // m√°s recientes primero

        const useLocal = !idx || rowsNewestFirst.length === 0;
        const items = useLocal
          ? (ACT_LOCAL || []).slice().map(a => ({
              when: a.ts,
              usuario: a.user,
              accion: a.action,
              descripcion: a.detail,
              movimientoId: a.movimientoId
            }))
          : rowsNewestFirst.map(r => ({
              when: idx.fechaHora >= 0 ? (r[idx.fechaHora] || "") : "",
              usuario: idx.usuario >= 0 ? (r[idx.usuario] || "") : "",
              accion: idx.accion >= 0 ? (r[idx.accion] || "") : "",
              descripcion: idx.descripcion >= 0 ? (r[idx.descripcion] || "") : "",
              movimientoId: idx.movimientoId >= 0 ? (r[idx.movimientoId] || "") : ""
            }));

        // paginaci√≥n
        ACT_PAG.totalItems = items.length;
        ACT_PAG.totalPages = Math.max(1, Math.ceil(ACT_PAG.totalItems / ACT_PAG.pageSize));
        if (ACT_PAG.page > ACT_PAG.totalPages) ACT_PAG.page = ACT_PAG.totalPages;
        if (ACT_PAG.page < 1) ACT_PAG.page = 1;
        const start = (ACT_PAG.page - 1) * ACT_PAG.pageSize;
        const end = start + ACT_PAG.pageSize;
        const pageItems = items.slice(start, end);

        // UI paginaci√≥n
        const info = document.getElementById("actividadInfo");
        const prev = document.getElementById("actividadPrev");
        const next = document.getElementById("actividadNext");
        const badge = document.getElementById("actividadPageBadge");

        if (info) {
          const a = ACT_PAG.totalItems === 0 ? 0 : (start + 1);
          const b = Math.min(end, ACT_PAG.totalItems);
          info.textContent = `Mostrando ${a}-${b} de ${ACT_PAG.totalItems} actividades`;
        }
        if (badge) badge.textContent = `${ACT_PAG.page}/${ACT_PAG.totalPages}`;

        if (prev) {
          prev.disabled = ACT_PAG.page <= 1;
          prev.onclick = () => {
            ACT_PAG.page = Math.max(1, ACT_PAG.page - 1);
            renderActividad();
          };
        }
        if (next) {
          next.disabled = ACT_PAG.page >= ACT_PAG.totalPages;
          next.onclick = () => {
            ACT_PAG.page = Math.min(ACT_PAG.totalPages, ACT_PAG.page + 1);
            renderActividad();
          };
        }

        pageItems.forEach(a => {
          const tr = document.createElement("tr");
          tr.className = "hover:bg-gray-50 transition duration-150";

          const dt = a.when ? new Date(a.when) : null;
          const when = dt && !isNaN(dt) ? dt.toLocaleString("es-CL") : (a.when || "");

          tr.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${when}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${a.usuario || ""}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-purple-700">${a.accion || ""}</td>
            <td class="px-6 py-4 text-sm text-gray-900">${a.descripcion || ""}</td>
          `;

          // Si tiene movimiento asociado, permitir abrir ticket
          if (a.movimientoId) {
            tr.classList.add("cursor-pointer");
            tr.title = "Ver ticket";
            tr.addEventListener("click", () => openTicketModalById(a.movimientoId));
          }

          tbody.appendChild(tr);
        });

        if (pageItems.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td class="px-6 py-6 text-sm text-gray-500" colspan="4">A√∫n no hay actividad registrada.</td>`;
          tbody.appendChild(tr);
        }
      });
    }

    function showTab(tabName, evOrBtn) {
      const safeTab = TAB_IDS.includes(tabName) ? tabName : "movimientos";
      CURRENT_TAB = safeTab;

      // hide all
      TAB_IDS.forEach(t => {
        const el = document.getElementById(`${t}-tab`);
        if (el) el.classList.add("hidden");
      });

      // show selected
      document.getElementById(`${safeTab}-tab`)?.classList.remove("hidden");

      // active styles on tabs
      document.querySelectorAll(".tabs-btn").forEach(b => {
        b.classList.remove("tab-active");
        b.classList.add("text-gray-600");
      });

      const btn = (evOrBtn && evOrBtn.target) ? evOrBtn.target.closest("button") : evOrBtn;
      if (btn) {
        btn.classList.add("tab-active");
        btn.classList.remove("text-gray-600");
      }

      // refresh dependent tabs
      if (["gastos","arriendos","proveedores","empleados","caja-chica","otros"].includes(safeTab)) {
        renderAreaTabs();
      }
      if (safeTab === "alertas") renderAlertas();
      if (safeTab === "resumen") renderResumenMensual();
      if (safeTab === "actividad") { ACT_PAG.page = 1; renderActividad(); }
    }

    function openNewMovementModal() {
      EDITING_ID = null;
      document.getElementById('modalTitle').textContent = 'Nuevo Movimiento';
      document.getElementById('modalSubmitText').textContent = 'Guardar Movimiento';
      document.getElementById('movementForm')?.reset();

      // defaults hoy / mes
      const d = new Date();
      const iso = d.toISOString().slice(0,10);
      const ym = iso.slice(0,7);
      const fEl = document.getElementById('mvFecha');
      if (fEl) fEl.value = iso;
      const pEl = document.getElementById('mvPeriodo');
      if (pEl) pEl.value = ym;

      // ‚úÖ default estado pago vac√≠o
      const ep = document.getElementById("mvEstadoPago");
      if (ep) ep.value = "";

      // ‚úÖ limpiar detalles adicionales
      const extraIds = [
        "mvLocal","mvEmpleado","mvArrendatarioPropietario","mvProveedorEmpresa","mvRut",
        "mvMetodoPago","mvFechaVencimiento","mvNumeroComprobante","mvConcepto","mvNotas"
      ];
      extraIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });

      document.getElementById('newMovementModal').classList.remove('hidden');
    }
    function closeModal() { document.getElementById('newMovementModal').classList.add('hidden'); }

    function closeTicketModal() {
      document.getElementById("movementTicketModal")?.classList.add("hidden");
    }

    function openTicketModalById(id) {
      if (!MOV?.idx || MOV.idx.id < 0) {
        alert("No puedo mostrar el detalle: falta la columna ID.");
        return;
      }
      const row = (MOV.rows || []).find(r => String(r[MOV.idx.id] || "") === String(id || ""));
      if (!row) {
        alert("No encontr√© el movimiento.");
        return;
      }

      const get = (colIdx) => (colIdx >= 0 ? (row[colIdx] ?? "") : "");
      const rawMonto = MOV.idx.monto >= 0 ? parseMoney(get(MOV.idx.monto)) : 0;
      const tipo = String(get(MOV.idx.tipo) || "");
      const estadoPagoRaw = String(get(MOV.idx.estadoPago) || "");
      const isAnulado = isAnuladoEstado(estadoPagoRaw);
      const montoBase = isAnulado ? 0 : Math.abs(rawMonto);
      const montoFmt = (tipo === "Egreso" ? "-" : "") + formatCLP(montoBase).replace("-", "");

      const fields = [
        { key: "ID", value: get(MOV.idx.id) },
        { key: "Fecha", value: formatFechaISO(get(MOV.idx.fecha)) },
        { key: "√Årea", value: get(MOV.idx.area) },
        { key: "Tipo", value: get(MOV.idx.tipo) },
        { key: "Descripci√≥n", value: get(MOV.idx.descripcion) },
        { key: "Monto", value: montoFmt },
        { key: "Responsable", value: get(MOV.idx.responsable) },
        { key: "Periodo", value: get(MOV.idx.periodo) },
        { key: "Estado de Pago", value: get(MOV.idx.estadoPago) },
        { key: "Local", value: get(MOV.idx.local) },
        { key: "Empleado", value: get(MOV.idx.empleado) },
        { key: "Arrendatario / Propietario", value: get(MOV.idx.arrendatarioPropietario) },
        { key: "Proveedor / Empresa", value: get(MOV.idx.proveedorEmpresa) },
        { key: "RUT", value: get(MOV.idx.rut) },
        { key: "M√©todo de Pago", value: get(MOV.idx.metodoPago) },
        { key: "Fecha Vencimiento", value: formatFechaISO(get(MOV.idx.fechaVencimiento)) },
        { key: "N√∫mero Comprobante", value: get(MOV.idx.numeroComprobante) },
        { key: "Concepto", value: get(MOV.idx.concepto) },
        { key: "Notas", value: get(MOV.idx.notas) },
      ].filter(f => String(f.value || "").trim() !== "");

      const ticketEl = document.getElementById("ticketContent");
      if (ticketEl) {
        ticketEl.innerHTML = `
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-sm text-gray-500">Movimiento</div>
              <div class="text-xl font-bold text-gray-900">${String(get(MOV.idx.area) || "Sin √°rea")}</div>
              <div class="mt-1 text-sm text-gray-600">${String(get(MOV.idx.descripcion) || "")}</div>
            </div>
            <div class="text-right">
              <div class="text-sm text-gray-500">${String(get(MOV.idx.tipo) || "")}</div>
              <div class="text-2xl font-extrabold ${isAnulado ? "text-gray-500" : (tipo === "Ingreso" ? "text-green-600" : "text-red-600")}">${montoFmt}</div>
              ${isAnulado ? `<div class="mt-1 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-gray-200 text-gray-700">ANULADO</div>` : ``}
            </div>
          </div>

          <div class="border-t border-gray-200 pt-4">
            <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
              ${fields.map(f => `
                <div class="flex justify-between sm:block">
                  <dt class="text-sm font-semibold text-gray-600">${f.key}</dt>
                  <dd class="text-sm text-gray-900 sm:mt-1 break-words">${String(f.value)}</dd>
                </div>
              `).join("")}
            </dl>
          </div>
        `;
      }

      const modal = document.getElementById("movementTicketModal");
      modal?.classList.remove("hidden");
    }


    async function apiFetch(path, options = {}) {
      const res = await fetch(path, {
        ...options,
        headers: { "Content-Type": "application/json", ...(authToken ? { "Authorization": `Bearer ${authToken}` } : {}), ...(options.headers || {}) }
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.ok === false) throw new Error(data.error || `HTTP ${res.status}`);
      return data;
    }


    async function initAuth() {
      if (!authToken) { window.location.href = "login.html"; return false; }

      // usa cache local r√°pido
      const cached = getStoredUser();
      if (cached) currentUser = cached;

      // valida token con backend (si falla, vuelve a login)
      try {
        const res = await fetch("/.netlify/functions/me", {
          method: "GET",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${authToken}` }
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false) throw new Error(data.error || `HTTP ${res.status}`);
        if (data.user) setStoredAuth(authToken, data.user);
      } catch (e) {
        clearAuth();
        window.location.href = "login.html";
        return false;
      }

      paintUserUI();
      applyRoleUI();
      return true;
    }

    function paintUserUI() {
      if (!currentUser) return;
      const avatar = document.getElementById("userAvatar");
      const nameEl = document.getElementById("userName");
      const roleEl = document.getElementById("userRoleLabel");
      const label = roleLabel(currentUser.role);

      if (avatar) avatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name || currentUser.email || "Usuario")}&background=fff&color=667eea`;
      if (nameEl) nameEl.textContent = currentUser.name || currentUser.email || "Usuario";
      if (roleEl) roleEl.textContent = label;
    }

    function roleLabel(role) {
      if (role === "admin") return "Administrador";
      if (role === "editor_full") return "Editor Full";
      if (role === "editor_limited") return "Editor Limited";
      return role || "";
    }

    function applyRoleUI() {
      const isAdmin = currentUser && currentUser.role === "admin";
      const exportBtn = document.getElementById("exportButton");
      if (exportBtn) exportBtn.style.display = isAdmin ? "" : "none";

      // pesta√±a actividad solo admin
      const actividadBtn = document.querySelector('.tabs-btn[data-tab="actividad"]');
      if (actividadBtn) actividadBtn.style.display = isAdmin ? "" : "none";

      // badge "Admin" en navbar (si existiera)
      document.querySelectorAll(".admin-only").forEach(el => {
        el.style.display = isAdmin ? "" : "none";
      });
    }

    function canEditRow(row) {
      const role = currentUser?.role;
      if (role === "admin" || role === "editor_full") return true;
      if (role !== "editor_limited") return false;

      const iCreated = MOV.idx?.creadoPorEmail ?? -1;
      const creator = iCreated >= 0 ? (row[iCreated] || "") : "";
      return norm(creator) === norm(currentUser.email || "");
    }
    function canDeleteRow(row) {
      const role = currentUser?.role;
      if (role === "admin" || role === "editor_full") return true;
      if (role !== "editor_limited") return false;
      const iCreated = MOV.idx?.creadoPorEmail ?? -1;
      const creator = iCreated >= 0 ? (row[iCreated] || "") : "";
      return norm(creator) === norm(currentUser.email || "");
    }


    function formatCLP(value) {
      const n = Number(value) || 0;
      return n.toLocaleString("es-CL", { style: "currency", currency: "CLP" });
    }
    function formatFechaISO(iso) {
      if (!iso || typeof iso !== "string") return "";
      const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (!m) return iso;
      return `${m[3]}/${m[2]}/${m[1]}`;
    }
    function norm(s) { return (s ?? "").toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }
    function findCol(header, candidates) {
      const h = (header || []).map(norm);
      for (const c of candidates) { const i = h.indexOf(norm(c)); if (i >= 0) return i; }
      return -1;
    }
    function parseMoney(v) {
      if (v == null) return 0;
      const cleaned = v.toString().trim().replace(/[^\d-]/g, "");
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : 0;
    }
    function isAnuladoEstado(estadoPago) {
      const e = norm(estadoPago);
      return e.includes("anul");
    }


    function setText(id, value) { const el = document.getElementById(id); if (el) el.textContent = value; }
    function monthOfFechaISO(fecha) { const m = (fecha || "").toString().match(/^(\d{4})-(\d{2})-(\d{2})/); return m ? `${m[1]}-${m[2]}` : ""; }

    // -----------------------------
    // Paginaci√≥n Movimientos
    // -----------------------------
    function clamp(n, min, max) { return Math.min(max, Math.max(min, n)); }

    function setMovFilteredRows(filteredRows, { resetPage = true } = {}) {
      // Orden: √∫ltimos primero (para mantener el comportamiento actual)
      MOV_PAG.ordered = (filteredRows || []).slice().reverse();
      if (resetPage) MOV_PAG.page = 1;
      renderMovPage();
    }

    function renderMovPage() {
      const total = MOV_PAG.ordered.length;
      const totalPages = Math.max(1, Math.ceil(total / MOV_PAG.pageSize));
      MOV_PAG.totalPages = totalPages;
      MOV_PAG.page = clamp(MOV_PAG.page, 1, totalPages);

      const startIdx = (MOV_PAG.page - 1) * MOV_PAG.pageSize;
      const endIdx = Math.min(startIdx + MOV_PAG.pageSize, total);
      const pageRows = MOV_PAG.ordered.slice(startIdx, endIdx);

      const start = total === 0 ? 0 : (startIdx + 1);
      const end = total === 0 ? 0 : endIdx;
      const infoEl = document.getElementById("movimientosInfo");
      if (infoEl) infoEl.textContent = `Mostrando ${start}-${end} de ${total} movimientos`;

      renderMovRows(pageRows);
      renderMovPagination();
    }

    function setMovPage(page) {
      MOV_PAG.page = page;
      renderMovPage();
    }

    function renderMovPagination() {
      const pagEl = document.getElementById("movimientosPagination");
      if (!pagEl) return;
      pagEl.innerHTML = "";

      const cur = MOV_PAG.page;
      const totalPages = MOV_PAG.totalPages || 1;

      function makeBtn(label, onClick, { active = false, disabled = false } = {}) {
        const b = document.createElement("button");
        b.type = "button";
        b.textContent = label;
        b.className = active
          ? "px-4 py-2 bg-purple-600 text-white rounded-lg"
          : "px-4 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50";
        if (disabled) {
          b.disabled = true;
          b.classList.remove("hover:bg-gray-50");
          b.classList.add("opacity-50", "cursor-not-allowed");
        } else if (typeof onClick === "function") {
          b.addEventListener("click", onClick);
        }
        return b;
      }

      function addEllipsis() {
        const s = document.createElement("span");
        s.className = "px-2 py-2 text-gray-500 select-none";
        s.textContent = "‚Ä¶";
        pagEl.appendChild(s);
      }

      // Anterior
      pagEl.appendChild(makeBtn("Anterior", () => setMovPage(cur - 1), { disabled: cur <= 1 }));

      const pages = [];
      if (totalPages <= 7) {
        for (let p = 1; p <= totalPages; p++) pages.push(p);
      } else {
        pages.push(1);
        const left = Math.max(2, cur - 1);
        const right = Math.min(totalPages - 1, cur + 1);

        if (left > 2) pages.push("‚Ä¶");
        for (let p = left; p <= right; p++) pages.push(p);
        if (right < totalPages - 1) pages.push("‚Ä¶");
        pages.push(totalPages);
      }

      pages.forEach(p => {
        if (p === "‚Ä¶") return addEllipsis();
        pagEl.appendChild(makeBtn(String(p), () => setMovPage(p), { active: p === cur }));
      });

      // Siguiente
      pagEl.appendChild(makeBtn("Siguiente", () => setMovPage(cur + 1), { disabled: cur >= totalPages }));
    }

    function buildIdx(header) {
      return {
        id: findCol(header, ["ID"]),
        fecha: findCol(header, ["Fecha"]),
        area: findCol(header, ["√Årea", "Area"]),
        tipo: findCol(header, ["Tipo"]),
        descripcion: findCol(header, ["Descripci√≥n", "Descripcion"]),
        monto: findCol(header, ["Monto", "MontoAsignado", "Monto Asignado", "Monto_Signado", "Monto Signado", "Monto_Asignado"]),
        responsable: findCol(header, ["Responsable"]),
        periodo: findCol(header, ["Periodo", "Per√≠odo", "Per√≠odo(YYYY-MM)", "Periodo(YYYY-MM)"]),
        // ‚úÖ Estado de Pago
        estadoPago: findCol(header, ["EstadoPago","Estado Pago","Estado de Pago","Estado"]),
        // ‚úÖ Detalles adicionales (opcional, pero √∫til para editar/leer desde Sheet)
        local: findCol(header, ["Local"]),
        empleado: findCol(header, ["Empleado"]),
        arrendatarioPropietario: findCol(header, ["Arrendatario/Propietario","Arrendatario-Propietario","Arrendatario / Propietario","ArrendatarioPropietario"]),
        proveedorEmpresa: findCol(header, ["Proveedor/Empresa","Proveedor - Empresa","Proveedor/Empresa","ProveedorEmpresa"]),
        rut: findCol(header, ["RUT","Rut"]),
        metodoPago: findCol(header, ["M√©todoPago","MetodoPago","Metodo de Pago","M√©todo de pago","MetodoPago"]),
        fechaVencimiento: findCol(header, ["FechaVencimiento","Fecha Vencimiento","Fecha vencimiento","FechaVencimiento"]),
        numeroComprobante: findCol(header, ["N¬∞Comprobante","N¬∫Comprobante","N¬∞ Comprobante","Numero Comprobante","N√∫mero comprobante","NumeroComprobante"]),
        concepto: findCol(header, ["Concepto"]),
        notas: findCol(header, ["Notas","Nota"]),
        creadoPorEmail: findCol(header, ["CreadoPorEmail","Creado Por Email","CreadoPorEmail","CreadoPor","Creado Por","CreadoPorMail","Creado Por Mail"]),
      };
    }

    function calcStatsFromMovs(header, rows) {
      const iMonto = findCol(header, ["MontoAsignado","Monto Asignado","Monto","Monto_Signado","Monto Signado","Monto_Asignado"]);
      const iTipo  = findCol(header, ["Tipo"]);
      const iFecha = findCol(header, ["Fecha"]);
      const iEstadoPago = findCol(header, ["EstadoPago","Estado Pago","Estado de Pago","Estado"]);
      const iArea  = findCol(header, ["√Årea","Area"]);
      const iFechaVenc = findCol(header, ["FechaVencimiento","Fecha Vencimiento","Fecha vencimiento"]);

      const now = new Date();
      const thisMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
      const prevMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      const prevMonth = `${prevMonthDate.getFullYear()}-${String(prevMonthDate.getMonth()+1).padStart(2,"0")}`;

      let ingresosMes=0, egresosMes=0, ingresosMesPrev=0, egresosMesPrev=0;
      let ingresosTotal=0, egresosTotal=0, morosos=0, morosos30=0, cajaChica=0;

      for (const r of (rows || [])) {
        const fecha = iFecha>=0 ? (r[iFecha]||"") : "";
        const tipo  = iTipo>=0 ? (r[iTipo]||"") : "";
        const area  = iArea>=0 ? (r[iArea]||"") : "";
        const tipoN = norm(tipo);
        const areaN = norm(area);
        const estadoPago = iEstadoPago>=0 ? (r[iEstadoPago]||"") : "";
        if (isAnuladoEstado(estadoPago)) continue;

        const monto = parseMoney(iMonto>=0 ? r[iMonto] : 0);

        const isIngreso = (tipoN==="ingreso") || (tipoN==="" && monto>0);
        const isEgreso  = (tipoN==="egreso")  || (tipoN==="" && monto<0);

        if (isIngreso) ingresosTotal += Math.abs(monto);
        if (isEgreso)  egresosTotal  += Math.abs(monto);

        const m = monthOfFechaISO(fecha);
        if (m === thisMonth) {
          if (isIngreso) ingresosMes += Math.abs(monto);
          if (isEgreso)  egresosMes  += Math.abs(monto);
        } else if (m === prevMonth) {
          if (isIngreso) ingresosMesPrev += Math.abs(monto);
          if (isEgreso)  egresosMesPrev  += Math.abs(monto);
        }

        if (estadoPago) {
          const e = norm(estadoPago);
          const isMoroso = e.includes("atras") || e.includes("moro") || e.includes("pend");
          if (isMoroso) {
            morosos++;
            // >30 d√≠as: usa FechaVencimiento si existe, si no usa Fecha
            const baseDateStr = (iFechaVenc >= 0 ? (r[iFechaVenc]||"") : "") || fecha;
            const dm = String(baseDateStr || "").match(/^(\d{4})-(\d{2})-(\d{2})/);
            if (dm) {
              const d = new Date(Number(dm[1]), Number(dm[2]) - 1, Number(dm[3]));
              const days = (now - d) / (1000*60*60*24);
              if (days > 30) morosos30++;
            }
          }
        }

        const isCajaChica = areaN==="caja chica" || areaN==="caja-chica" || areaN==="cajachica";
        if (isCajaChica) {
          if (isIngreso) cajaChica += Math.abs(monto);
          if (isEgreso)  cajaChica -= Math.abs(monto);
        }
      }

      return {
        ingresosMes, egresosMes, ingresosMesPrev, egresosMesPrev,
        ingresosTotal, egresosTotal,
        balanceTotal: ingresosTotal-egresosTotal,
        morosos, morosos30,
        cajaChica
      };
    }

 function updateCards(header, rows) {
  const s = calcStatsFromMovs(header, rows);

  setText("cardIngresosMes", formatCLP(s.ingresosMes));
  setText("cardEgresosMes", formatCLP(s.egresosMes));
  setText("cardIngresosTotal", formatCLP(s.ingresosTotal));
  setText("cardEgresosTotal", formatCLP(s.egresosTotal));

  // ‚úÖ Balance correcto = ingresos - egresos (anulados excluidos)
  const balanceTotal = (Number(s.ingresosTotal) || 0) - (Number(s.egresosTotal) || 0);
  setText("cardBalanceTotal", formatCLP(balanceTotal));

  // L√≠neas din√°micas (vs mes anterior)
  const pctLine = (cur, prev) => {
    const c = Number(cur) || 0;
    const p = Number(prev) || 0;
    if (p <= 0) return "Sin mes anterior";
    const pct = ((c - p) / p) * 100;
    const sign = pct > 0 ? "+" : "";
    return `${sign}${pct.toFixed(0)}% vs mes anterior`;
  };
  setText("cardIngresosMesLine", pctLine(s.ingresosMes, s.ingresosMesPrev));
  setText("cardEgresosMesLine", pctLine(s.egresosMes, s.egresosMesPrev));
  setText("cardMorososLine", `${Number(s.morosos30) || 0} con m√°s de 30 d√≠as`);

  setText("cardMorosos", String(s.morosos));
  setText("cardCajaChica", formatCLP(s.cajaChica));
}


    function readModalFields() {
      const fecha = document.getElementById("mvFecha")?.value?.trim() || "";
      const areaRaw = document.getElementById("mvArea")?.value?.trim() || "";
      const tipoRaw = document.querySelector('#movementForm input[name="tipo"]:checked')?.value?.trim() || "";
      const descripcion = document.getElementById("mvDescripcion")?.value?.trim() || "";
      const monto = Number(document.getElementById("mvMonto")?.value || 0) || 0;
      const periodo = document.getElementById("mvPeriodo")?.value?.trim() || "";

      // ‚úÖ Estado de Pago
      const estadoPago = document.getElementById("mvEstadoPago")?.value?.trim() || "";

      // ‚úÖ Detalles adicionales (restaurados)
      const local = document.getElementById("mvLocal")?.value?.trim() || "";
      const empleado = document.getElementById("mvEmpleado")?.value?.trim() || "";
      const arrendatarioPropietario = document.getElementById("mvArrendatarioPropietario")?.value?.trim() || "";
      const proveedorEmpresa = document.getElementById("mvProveedorEmpresa")?.value?.trim() || "";
      const rut = document.getElementById("mvRut")?.value?.trim() || "";
      const metodoPago = document.getElementById("mvMetodoPago")?.value?.trim() || "";
      const fechaVencimiento = document.getElementById("mvFechaVencimiento")?.value?.trim() || "";
      const numeroComprobante = document.getElementById("mvNumeroComprobante")?.value?.trim() || "";
      const concepto = document.getElementById("mvConcepto")?.value?.trim() || "";
      const notas = document.getElementById("mvNotas")?.value?.trim() || "";

      const AREA_MAP = {
        "gastos-comunes": "Gastos Comunes",
        "arriendos": "Arriendos",
        "proveedores": "Proveedores",
        "empleados": "Empleados",
        "caja-chica": "Caja Chica",
        "otros": "Otros"
      };
      const area = AREA_MAP[areaRaw] || areaRaw;
      const tipo = (tipoRaw === "ingreso" ? "Ingreso" : tipoRaw === "egreso" ? "Egreso" : tipoRaw);

      if (!fecha || !area || !tipo || !descripcion) {
        throw new Error(`Faltan campos requeridos (fecha, area, tipo, descripcion).`);
      }

      return {
        fecha, area, tipo, descripcion, monto,
        responsable: currentUser?.name || "Admin",
        periodo,

        // ‚úÖ Estado de Pago
        estadoPago,

        // ‚úÖ Detalles adicionales
        local,
        empleado,

        // ‚úÖ FIX: estos nombres son los que espera la funci√≥n Netlify (A:Y)
        // (as√≠ se guardan en las columnas correctas del Sheet)
        arrendatario: arrendatarioPropietario,
        proveedor: proveedorEmpresa,
        nComprobante: numeroComprobante,

        // (mantenemos los nombres usados en UI/ticket)
        arrendatarioPropietario,
        proveedorEmpresa,
        rut,
        metodoPago,
        fechaVencimiento,
        numeroComprobante,
        concepto,
        notas,

        // ‚úÖ Duplicados ‚Äúamigables‚Äù por si tu Sheet usa headers distintos
        "Local": local,
        "Empleado": empleado,
        "Arrendatario/Propietario": arrendatarioPropietario,
        "Arrendatario-Propietario": arrendatarioPropietario,
        "Arrendatario / Propietario": arrendatarioPropietario,
        "Proveedor - Empresa": proveedorEmpresa,
        "Proveedor/Empresa": proveedorEmpresa,
        "RUT": rut,
        "Rut": rut,
        "M√©todoPago": metodoPago,
        "MetodoPago": metodoPago,
        "Metodo de Pago": metodoPago,
        "M√©todo de pago": metodoPago,
        "Fecha Vencimiento": fechaVencimiento,
        "Fecha vencimiento": fechaVencimiento,
        "N¬∞Comprobante": numeroComprobante,
        "N¬∫Comprobante": numeroComprobante,
        "Numero Comprobante": numeroComprobante,
        "N√∫mero comprobante": numeroComprobante,
        "Concepto": concepto,
        "Notas": notas
      };
    }

    async function saveMovement(event) {
      event.preventDefault();
      try {
        const payload = readModalFields();

        if (EDITING_ID) {
          payload.id = EDITING_ID; // PUT espera id en body
          const result = await apiFetch(`/.netlify/functions/movimientos`, {
            method: "PUT",
            body: JSON.stringify(payload)
          });
          alert(`‚úÖ Movimiento editado!\nID: ${result.id || EDITING_ID}`);
          logAction("Editar", `${payload.area} ¬∑ ${payload.tipo} ¬∑ ${formatCLP(payload.monto)} ¬∑ ${payload.descripcion} ¬∑ ${payload.estadoPago || "Sin estado"}`, EDITING_ID);
        } else {
          const result = await apiFetch("/.netlify/functions/movimientos", {
            method: "POST",
            body: JSON.stringify(payload)
          });
          alert(`‚úÖ Movimiento guardado!\nID: ${result.id}`);
          logAction("Crear", `${payload.area} ¬∑ ${payload.tipo} ¬∑ ${formatCLP(payload.monto)} ¬∑ ${payload.descripcion} ¬∑ ${payload.estadoPago || "Sin estado"}`, result.id);
        }

        closeModal();
        await loadMovimientos();
      } catch (err) {
        alert("‚ùå Error guardando: " + err.message);
        console.error(err);
      }
    }

    function getFilters() {
      return {
        area: document.getElementById("filterArea")?.value || "Todas las √°reas",
        tipo: document.getElementById("filterTipo")?.value || "Todos",
        desde: document.getElementById("filterDesde")?.value || "",
        hasta: document.getElementById("filterHasta")?.value || ""
      };
    }

    function applyFiltersAndRender() {
      const tbody = document.getElementById("movimientosBody");
      if (!tbody || !MOV.idx) return;

      const { area, tipo, desde, hasta } = getFilters();
      let filtered = MOV.rows.slice();

      if (area !== "Todas las √°reas") filtered = filtered.filter(r => (r[MOV.idx.area] || "") === area);
      if (tipo !== "Todos") filtered = filtered.filter(r => (r[MOV.idx.tipo] || "") === tipo);
      if (desde) filtered = filtered.filter(r => (r[MOV.idx.fecha] || "") >= desde);
      if (hasta) filtered = filtered.filter(r => (r[MOV.idx.fecha] || "") <= hasta);

      setMovFilteredRows(filtered, { resetPage: true });
    }

    function renderMovRows(rows) {
      const tbody = document.getElementById("movimientosBody");
      if (!tbody) return;
      tbody.innerHTML = "";

      (rows || []).forEach(r => {
        const id = MOV.idx.id >= 0 ? (r[MOV.idx.id] || "") : "";
        const fecha = MOV.idx.fecha >= 0 ? r[MOV.idx.fecha] : "";
        const area = MOV.idx.area >= 0 ? r[MOV.idx.area] : "";
        const tipo = MOV.idx.tipo >= 0 ? r[MOV.idx.tipo] : "";
        const descripcion = MOV.idx.descripcion >= 0 ? r[MOV.idx.descripcion] : "";
        const monto = MOV.idx.monto >= 0 ? parseMoney(r[MOV.idx.monto]) : 0;
        const responsable = MOV.idx.responsable >= 0 ? r[MOV.idx.responsable] : "";

        const tipoBadge =
          tipo === "Ingreso"
            ? `<span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800"><i class="fas fa-arrow-up mr-1"></i>Ingreso</span>`
            : `<span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800"><i class="fas fa-arrow-down mr-1"></i>Egreso</span>`;

        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50 transition duration-150";
        tr.innerHTML = `
          <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900"><input type="checkbox" class="movRowSelect h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500" data-id="${id}"></td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatFechaISO(fecha)}</td>
          <td class="px-6 py-4 whitespace-nowrap"><span class="px-3 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">${area || ""}</span></td>
          <td class="px-6 py-4 whitespace-nowrap">${tipoBadge}</td>
          <td class="px-6 py-4 text-sm text-gray-900">${descripcion || ""}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${tipo === "Ingreso" ? "text-green-600" : "text-red-600"}">
            ${tipo === "Egreso" ? "-" : ""}${formatCLP(monto).replace("-", "")}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600"><i class="fas fa-user-circle mr-1"></i>${responsable || ""}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <button class="text-blue-600 hover:text-blue-900 mr-3" data-action="view" data-id="${id}" title="Ver ticket"><i class="fas fa-receipt"></i></button>
            <button class="text-gray-600 hover:text-gray-900 mr-3" data-action="print" data-id="${id}" title="Imprimir"><i class="fas fa-print"></i></button>
            ${(() => {
              const _canEdit = canEditRow(r);
              const _canDelete = canDeleteRow(r);
              const editBtn = _canEdit
                ? '<button class="text-purple-600 hover:text-purple-900 mr-3" data-action="edit" data-id="'+id+'" title="Editar"><i class="fas fa-edit"></i></button>'
                : '<button class="text-gray-300 mr-3 cursor-not-allowed" disabled title="Sin permiso"><i class="fas fa-edit"></i></button>';
              const delBtn = _canDelete
                ? '<button class="text-red-600 hover:text-red-900" data-action="delete" data-id="'+id+'" title="Eliminar"><i class="fas fa-trash"></i></button>'
                : '<button class="text-gray-300 cursor-not-allowed" disabled title="Sin permiso"><i class="fas fa-trash"></i></button>';
              return editBtn + delBtn;
            })()}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Helpers para pesta√±as por √°rea / resumen / alertas
    function signedAmount(tipo, monto, estadoPago) {
      if (isAnuladoEstado(estadoPago)) return 0;
      const t = (tipo || "").toString().trim();
      const m = Math.abs(Number(monto) || 0);
      if (t === "Egreso") return -m;
      if (t === "Ingreso") return m;
      return Number(monto) || 0;
    }

    function filterRowsByArea(areaName) {
      if (!MOV.idx || MOV.idx.area < 0) return [];
      return (MOV.rows || []).filter(r => (r[MOV.idx.area] || "") === areaName);
    }

    function calcCountAndTotal(rows) {
      let total = 0;
      let count = 0;
      for (const r of (rows || [])) {
        const estadoPago = MOV.idx?.estadoPago >= 0 ? (r[MOV.idx.estadoPago] || "") : "";
        if (isAnuladoEstado(estadoPago)) continue;
        const tipo = MOV.idx?.tipo >= 0 ? (r[MOV.idx.tipo] || "") : "";
        const monto = MOV.idx?.monto >= 0 ? parseMoney(r[MOV.idx.monto]) : 0;
        total += signedAmount(tipo, monto, estadoPago);
        count++;
      }
      return { count, total };
    }

    function renderMovRowsInto(tbodyId, rows) {
      const tbody = document.getElementById(tbodyId);
      if (!tbody) return;
      tbody.innerHTML = "";

      const lastRows = (rows || []).slice().reverse().slice(0, 20);
      lastRows.forEach(r => {
        const id = MOV.idx.id >= 0 ? (r[MOV.idx.id] || "") : "";
        const fecha = MOV.idx.fecha >= 0 ? (r[MOV.idx.fecha] || "") : "";
        const tipo = MOV.idx.tipo >= 0 ? (r[MOV.idx.tipo] || "") : "";
        const descripcion = MOV.idx.descripcion >= 0 ? (r[MOV.idx.descripcion] || "") : "";
        const monto = MOV.idx.monto >= 0 ? parseMoney(r[MOV.idx.monto]) : 0;
        const responsable = MOV.idx.responsable >= 0 ? (r[MOV.idx.responsable] || "") : "";

        const tipoBadge =
          tipo === "Ingreso"
            ? `<span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800"><i class="fas fa-arrow-up mr-1"></i>Ingreso</span>`
            : `<span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800"><i class="fas fa-arrow-down mr-1"></i>Egreso</span>`;

        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50 transition duration-150";
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatFechaISO(fecha)}</td>
          <td class="px-6 py-4 whitespace-nowrap">${tipoBadge}</td>
          <td class="px-6 py-4 text-sm text-gray-900">${descripcion}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${tipo === "Ingreso" ? "text-green-600" : "text-red-600"}">
            ${tipo === "Egreso" ? "-" : ""}${formatCLP(monto).replace("-", "")}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600"><i class="fas fa-user-circle mr-1"></i>${responsable}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <button class="text-blue-600 hover:text-blue-900 mr-3" data-action="view" data-id="${id}" title="Ver ticket"><i class="fas fa-receipt"></i></button>
            ${(() => {
              const _canEdit = canEditRow(r);
              const _canDelete = canDeleteRow(r);
              const editBtn = _canEdit
                ? '<button class="text-purple-600 hover:text-purple-900 mr-3" data-action="edit" data-id="'+id+'" title="Editar"><i class="fas fa-edit"></i></button>'
                : '<button class="text-gray-300 mr-3 cursor-not-allowed" disabled title="Sin permiso"><i class="fas fa-edit"></i></button>';
              const delBtn = _canDelete
                ? '<button class="text-red-600 hover:text-red-900" data-action="delete" data-id="'+id+'" title="Eliminar"><i class="fas fa-trash"></i></button>'
                : '<button class="text-gray-300 cursor-not-allowed" disabled title="Sin permiso"><i class="fas fa-trash"></i></button>';
              return editBtn + delBtn;
            })()}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderAreaTabs() {
      const gastos = filterRowsByArea("Gastos Comunes");
      const g = calcCountAndTotal(gastos);
      setText("gastosCount", String(g.count));
      setText("gastosTotal", formatCLP(g.total));
      renderMovRowsInto("gastosBody", gastos);

      const ar = filterRowsByArea("Arriendos");
      const a = calcCountAndTotal(ar);
      setText("arriendosCount", String(a.count));
      setText("arriendosTotal", formatCLP(a.total));
      renderMovRowsInto("arriendosBody", ar);

      const pr = filterRowsByArea("Proveedores");
      const p = calcCountAndTotal(pr);
      setText("proveedoresCount", String(p.count));
      setText("proveedoresTotal", formatCLP(p.total));
      renderMovRowsInto("proveedoresBody", pr);

      const em = filterRowsByArea("Empleados");
      const e = calcCountAndTotal(em);
      setText("empleadosCount", String(e.count));
      setText("empleadosTotal", formatCLP(e.total));
      renderMovRowsInto("empleadosBody", em);

      const cc = filterRowsByArea("Caja Chica");
      const c = calcCountAndTotal(cc);
      setText("cajaChicaCount", String(c.count));
      setText("cajaChicaTotal", formatCLP(c.total));
      renderMovRowsInto("cajaChicaBody", cc);

      const ot = filterRowsByArea("Otros");
      const o = calcCountAndTotal(ot);
      setText("otrosCount", String(o.count));
      setText("otrosTotal", formatCLP(o.total));
      renderMovRowsInto("otrosBody", ot);
    }

    function renderAlertas() {
      const list = document.getElementById("alertasList");
      if (!list) return;

      const iId    = MOV.idx?.id ?? findCol(MOV.header, ["ID"]);
      const iEstado= MOV.idx?.estadoPago ?? findCol(MOV.header, ["EstadoPago","Estado Pago","Estado de Pago","Estado"]);
      const iFecha = MOV.idx?.fecha ?? -1;
      const iDesc  = MOV.idx?.descripcion ?? -1;
      const iTipo  = MOV.idx?.tipo ?? -1;
      const iMonto = MOV.idx?.monto ?? -1;
      const iArea  = MOV.idx?.area ?? -1;

      const alerts = [];

      // Pendientes / atrasados / morosos
      if (iEstado >= 0) {
        for (const r of (MOV.rows || [])) {
          const estado = (r[iEstado] || "").toString();
          if (isAnuladoEstado(estado)) continue;
          const e = norm(estado);
          if (e.includes("pend") || e.includes("atras") || e.includes("moro")) {
            const id = iId >= 0 ? (r[iId] || "") : "";
            alerts.push({
              kind: "warn",
              id,
              title: "Pago pendiente/atrasado",
              text: `${formatFechaISO(r[iFecha] || "")} ¬∑ ${(r[iArea] || "")} ¬∑ ${(r[iDesc] || "")}`
            });
          }
        }
      }

      // Egresos altos
      const TH = 200000;
      for (const r of (MOV.rows || [])) {
        const tipo = iTipo >= 0 ? (r[iTipo] || "") : "";
        const estado = iEstado >= 0 ? (r[iEstado] || "") : "";
        if (isAnuladoEstado(estado)) continue;
        const monto = iMonto >= 0 ? Math.abs(parseMoney(r[iMonto])) : 0;
        if (tipo === "Egreso" && monto >= TH) {
          const id = iId >= 0 ? (r[iId] || "") : "";
          alerts.push({
            kind: "danger",
            id,
            title: "Egreso alto",
            text: `${formatFechaISO(r[iFecha] || "")} ¬∑ ${(r[iArea] || "")} ¬∑ ${formatCLP(monto)} ¬∑ ${(r[iDesc] || "")}`
          });
        }
      }

      // Orden: m√°s recientes primero (por fecha)
      const sortKey = (a) => {
        const t = (a.text || "");
        const m = t.match(/(\d{2})\/(\d{2})\/(\d{4})/);
        if (!m) return 0;
        return new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1])).getTime();
      };
      alerts.sort((a,b) => sortKey(b) - sortKey(a));

      const shown = alerts.slice(0, 10);
      setText("alertasCount", String(shown.length));

      // Badges (navbar y pesta√±a)
      const badgeTop = document.getElementById("navAlertasBadge");
      const badgeTab = document.getElementById("tabAlertasBadge");
      const setBadge = (el) => {
        if (!el) return;
        if (shown.length > 0) {
          el.textContent = String(shown.length);
          el.classList.remove("hidden");
        } else {
          el.classList.add("hidden");
        }
      };
      setBadge(badgeTop);
      setBadge(badgeTab);

      list.innerHTML = "";

      if (shown.length === 0) {
        list.innerHTML = `<div class="p-4 rounded-lg bg-green-50 border border-green-200 text-green-800">
          <i class="fas fa-check-circle mr-2"></i>No hay alertas por ahora.
        </div>`;
        return;
      }

      shown.forEach(a => {
        const cls = a.kind === "danger"
          ? "bg-red-50 border-red-200 text-red-800"
          : "bg-yellow-50 border-yellow-200 text-yellow-800";
        const icon = a.kind === "danger" ? "fa-triangle-exclamation" : "fa-circle-exclamation";
        const div = document.createElement("div");
        div.className = `p-4 rounded-lg border ${cls} cursor-pointer hover:shadow-sm transition`;
        div.innerHTML = `<div class="font-semibold"><i class="fas ${icon} mr-2"></i>${a.title}</div><div class="text-sm mt-1">${a.text}</div>`;
        if (a.id) {
          div.title = "Ver ticket";
          div.addEventListener("click", () => openTicketModalById(a.id));
        }
        list.appendChild(div);
      });
    }


    function renderResumenMensual() {
      const now = new Date();
      const thisMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
      setText("resumenMes", thisMonth);

      const iFecha = MOV.idx?.fecha ?? -1;
      const iArea  = MOV.idx?.area ?? -1;
      const iTipo  = MOV.idx?.tipo ?? -1;
      const iMonto = MOV.idx?.monto ?? -1;

      const monthRows = (MOV.rows || []).filter(r => {
        const f = iFecha >= 0 ? (r[iFecha] || "") : "";
        const estado = MOV.idx?.estadoPago >= 0 ? (r[MOV.idx.estadoPago] || "") : "";
        if (isAnuladoEstado(estado)) return false;
        return monthOfFechaISO(f) === thisMonth;
      });

      let ing = 0, egr = 0;
      const byArea = new Map();

      for (const r of monthRows) {
        const area = iArea >= 0 ? (r[iArea] || "Sin √°rea") : "Sin √°rea";
        const tipo = iTipo >= 0 ? (r[iTipo] || "") : "";
        const monto = iMonto >= 0 ? Math.abs(parseMoney(r[iMonto])) : 0;

        const obj = byArea.get(area) || { ing: 0, egr: 0 };
        if (tipo === "Ingreso") { ing += monto; obj.ing += monto; }
        if (tipo === "Egreso")  { egr += monto; obj.egr += monto; }
        byArea.set(area, obj);
      }

      setText("resumenIngresosMes", formatCLP(ing));
      setText("resumenEgresosMes", formatCLP(egr));
      setText("resumenBalanceMes", formatCLP(ing - egr));

      const tbody = document.getElementById("resumenTopAreas");
      if (!tbody) return;
      tbody.innerHTML = "";

      const entries = Array.from(byArea.entries())
        .map(([area, v]) => ({ area, ...v, neto: v.ing - v.egr }))
        .sort((a,b) => Math.abs(b.neto) - Math.abs(a.neto))
        .slice(0, 10);

      if (entries.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="px-6 py-4 text-sm text-gray-500" colspan="4">No hay movimientos en este mes.</td>`;
        tbody.appendChild(tr);
        return;
      }

      entries.forEach(x => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50 transition duration-150";
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${x.area}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-green-700 font-semibold">${formatCLP(x.ing)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-red-700 font-semibold">${formatCLP(x.egr)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${x.neto >= 0 ? "text-green-700" : "text-red-700"}">${formatCLP(x.neto)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ‚úÖ helper para leer un valor del row seg√∫n posibles headers del sheet
    function getCell(row, header, names) {
      const i = findCol(header, names);
      return i >= 0 ? (row[i] || "") : "";
    }

    function openEditModalById(id) {
      if (!id) return;
      const idx = MOV.idx;
      const row = MOV.rows.find(r => (idx.id >= 0 ? (r[idx.id] || "") : "") === id);
      if (!row) return alert("No encontr√© el movimiento en cache: " + id);

      EDITING_ID = id;
      document.getElementById('modalTitle').textContent = 'Editar Movimiento';
      document.getElementById('modalSubmitText').textContent = 'Guardar Cambios';

      const fecha = idx.fecha >= 0 ? (row[idx.fecha] || "") : "";
      const area = idx.area >= 0 ? (row[idx.area] || "") : "";
      const tipo = idx.tipo >= 0 ? (row[idx.tipo] || "") : "";
      const descripcion = idx.descripcion >= 0 ? (row[idx.descripcion] || "") : "";
      const monto = idx.monto >= 0 ? parseMoney(row[idx.monto]) : 0;
      const periodo = idx.periodo >= 0 ? (row[idx.periodo] || "") : "";

      document.getElementById("mvFecha").value = fecha;

      const AREA_REV = {
        "Gastos Comunes": "gastos-comunes",
        "Arriendos": "arriendos",
        "Proveedores": "proveedores",
        "Empleados": "empleados",
        "Caja Chica": "caja-chica",
        "Otros": "otros"
      };
      document.getElementById("mvArea").value = AREA_REV[area] || "";

      document.getElementById("mvTipoIngreso").checked = false;
      document.getElementById("mvTipoEgreso").checked = false;
      if (tipo === "Ingreso") document.getElementById("mvTipoIngreso").checked = true;
      if (tipo === "Egreso") document.getElementById("mvTipoEgreso").checked = true;

      document.getElementById("mvDescripcion").value = descripcion;
      document.getElementById("mvMonto").value = Math.abs(monto);
      if (periodo) document.getElementById("mvPeriodo").value = periodo;

      // ‚úÖ cargar estado pago si viene en el sheet
      const ep = document.getElementById("mvEstadoPago");
      if (ep) {
        ep.value = (idx.estadoPago >= 0 ? (row[idx.estadoPago] || "") : "");
      }

      // ‚úÖ cargar detalles adicionales si vienen en el sheet
      const setIf = (idEl, val) => {
        const el = document.getElementById(idEl);
        if (el != null) el.value = val || "";
      };

      setIf("mvLocal", getCell(row, MOV.header, ["Local"]));
      setIf("mvEmpleado", getCell(row, MOV.header, ["Empleado"]));
      setIf("mvArrendatarioPropietario", getCell(row, MOV.header, ["Arrendatario/Propietario","Arrendatario-Propietario","Arrendatario / Propietario","ArrendatarioPropietario"]));
      setIf("mvProveedorEmpresa", getCell(row, MOV.header, ["Proveedor/Empresa","Proveedor - Empresa","ProveedorEmpresa"]));
      setIf("mvRut", getCell(row, MOV.header, ["RUT","Rut"]));
      setIf("mvMetodoPago", getCell(row, MOV.header, ["M√©todoPago","MetodoPago","Metodo de Pago","M√©todo de pago","MetodoPago"]));
      setIf("mvFechaVencimiento", getCell(row, MOV.header, ["FechaVencimiento","Fecha Vencimiento","Fecha vencimiento","FechaVencimiento"]));
      setIf("mvNumeroComprobante", getCell(row, MOV.header, ["N¬∞Comprobante","N¬∫Comprobante","N¬∞ Comprobante","Numero Comprobante","N√∫mero comprobante","NumeroComprobante"]));
      setIf("mvConcepto", getCell(row, MOV.header, ["Concepto"]));
      setIf("mvNotas", getCell(row, MOV.header, ["Notas","Nota"]));

      document.getElementById('newMovementModal').classList.remove('hidden');
    }

    async function deleteMovimientoById(id) {
      if (!id) return;
      if (!confirm(`¬øEliminar movimiento?\nID: ${id}`)) return;
      try {
        await apiFetch(`/.netlify/functions/movimientos?id=${encodeURIComponent(id)}`, { method: "DELETE" });
        alert("‚úÖ Eliminado: " + id);
        logAction("Eliminar", `ID: ${id}`, id);
        await loadMovimientos();
      } catch (e) {
        alert("‚ùå No pude eliminar: " + e.message);
      }
    }

    async function loadMovimientos() {
      const data = await apiFetch("/.netlify/functions/movimientos");
      MOV.header = data.header || [];
      MOV.rows = data.rows || [];
      MOV.idx = buildIdx(MOV.header);

      updateCards(MOV.header, MOV.rows);
      applyFiltersAndRender();
      renderAreaTabs();

      // alertas: refrescar siempre (para badges)
      renderAlertas();
      if (CURRENT_TAB === "resumen") renderResumenMensual();
      if (CURRENT_TAB === "actividad") renderActividad();
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const authOk = await initAuth();
      if (!authOk) return;
      document.getElementById("logoutBtn")?.addEventListener("click", () => { clearAuth(); window.location.href = "login.html"; });

      // Tabs click
      document.querySelectorAll(".tabs-btn[data-tab]").forEach(btn => {
        btn.addEventListener("click", () => {
          showTab(btn.dataset.tab, btn);
        });
      });


      // Campana (navbar): abre pesta√±a Alertas
      const bellBtn = document.getElementById("navBellBtn");
      if (bellBtn) {
        bellBtn.addEventListener("click", () => {
          const tabBtn = document.querySelector('.tabs-btn[data-tab="alertas"]');
          showTab("alertas", tabBtn);
          document.getElementById("alertas-tab")?.scrollIntoView({ behavior: "smooth", block: "start" });
        });
      }

      // initial tab
      const firstTabBtn = document.querySelector('.tabs-btn[data-tab="movimientos"]');
      showTab("movimientos", firstTabBtn);

      document.getElementById("movementForm")?.addEventListener("submit", saveMovement);
      loadMovimientos().catch(console.error);

      ["filterArea","filterTipo","filterDesde","filterHasta"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener("change", applyFiltersAndRender);
      });


      // Cerrar modal ticket al hacer click fuera del contenido
      const ticketModal = document.getElementById("movementTicketModal");
      if (ticketModal) {
        ticketModal.addEventListener("click", (ev) => {
          if (ev.target === ticketModal) closeTicketModal();
        });
      }

      // Edit/Delete from any tab table (delegation)
      document.body.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;
        const action = btn.dataset.action;
        const id = btn.dataset.id;
        if (action === "view") openTicketModalById(id);
        if (action === "edit") openEditModalById(id);
        if (action === "delete") deleteMovimientoById(id);
              if (action === "print") printTicketById(id);
});

      // Export
      const exportButton = document.getElementById("exportButton");
      if (exportButton) {
        if (currentUser.role !== "admin") {
          exportButton.classList.add("opacity-50", "cursor-not-allowed");
          exportButton.onclick = (e) => { e.preventDefault(); alert("‚õî Solo el Administrador puede exportar datos del sistema"); };
        } else {
          exportButton.onclick = () => { window.ANF_EXPORT.runExport(); };

        }
      }

      // Close modal on overlay click
      const modal = document.getElementById('newMovementModal');
      if (modal) modal.addEventListener('click', function(e) { if (e.target === this) closeModal(); });
    });
  </script>

  <script src="exporter.js"></script>

  <script src="print-tickets.js"></script>
  
</body>
</html>
