<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anfiteatro Registro - Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    * { font-family: 'Inter', sans-serif; }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-card-green { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-card-orange { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .stat-card-purple { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
    input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; filter: invert(0.5); }
    .notification-badge { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .tab-active { border-bottom: 3px solid #667eea; color: #667eea; font-weight: 600; }
    .modal-overlay { backdrop-filter: blur(4px); }
  </style>
</head>

<body class="bg-gray-50">
  <nav class="gradient-bg text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-4">
          <i class="fas fa-building text-2xl"></i>
          <div>
            <h1 class="text-xl font-bold">Anfiteatro Registro</h1>
            <p class="text-xs text-purple-200">Sistema de Gesti√≥n Comercial</p>
          </div>
        </div>
        <div class="flex items-center space-x-6">
          <div class="relative">
            <i class="fas fa-bell text-xl cursor-pointer"></i>
            <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center notification-badge">3</span>
          </div>
          <div class="flex items-center space-x-2">
            <img src="https://ui-avatars.com/api/?name=Admin&background=fff&color=667eea" class="h-8 w-8 rounded-full" alt="User">
            <div class="text-sm">
              <p class="font-semibold">Admin</p>
              <p class="text-xs text-purple-200">Administrador</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
      <div class="stat-card rounded-xl p-6 text-white card-hover cursor-pointer">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-sm opacity-90">Ingresos Mes</p>
            <h3 class="text-3xl font-bold mt-2"><span id="cardIngresosMes">$0</span></h3>
            <p class="text-xs mt-2 opacity-75">+12% vs mes anterior</p>
          </div>
          <i class="fas fa-arrow-trend-up text-3xl opacity-50"></i>
        </div>
      </div>

      <div class="stat-card-green rounded-xl p-6 text-white card-hover cursor-pointer">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-sm opacity-90">Egresos Mes</p>
            <h3 class="text-3xl font-bold mt-2"><span id="cardEgresosMes">$0</span></h3>
            <p class="text-xs mt-2 opacity-75">-5% vs mes anterior</p>
          </div>
          <i class="fas fa-arrow-trend-down text-3xl opacity-50"></i>
        </div>
      </div>

      <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl p-6 text-white card-hover cursor-pointer shadow-lg">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-sm opacity-90">Balance Total</p>
            <h3 class="text-3xl font-bold mt-2"><span id="cardBalanceTotal">$0</span></h3>
            <p class="text-xs mt-2 opacity-75"><i class="fas fa-arrow-up mr-1"></i><span id="cardIngresosTotal">$0</span> ingresos</p>
            <p class="text-xs opacity-75"><i class="fas fa-arrow-down mr-1"></i><span id="cardEgresosTotal">$0</span> egresos</p>
          </div>
          <i class="fas fa-chart-line text-3xl opacity-50"></i>
        </div>
      </div>

      <div class="stat-card-orange rounded-xl p-6 text-white card-hover cursor-pointer">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-sm opacity-90">Morosos</p>
            <h3 class="text-3xl font-bold mt-2"><span id="cardMorosos">0</span></h3>
            <p class="text-xs mt-2 opacity-75">3 con m√°s de 30 d√≠as</p>
          </div>
          <i class="fas fa-exclamation-triangle text-3xl opacity-50"></i>
        </div>
      </div>

      <div class="stat-card-purple rounded-xl p-6 text-gray-800 card-hover cursor-pointer">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-sm opacity-90">Caja Chica</p>
            <h3 class="text-3xl font-bold mt-2"><span id="cardCajaChica">$0</span></h3>
            <p class="text-xs mt-2 opacity-75">Saldo disponible</p>
          </div>
          <i class="fas fa-wallet text-3xl opacity-50"></i>
        </div>
      </div>
    </div>

    <!-- Tabs bar -->
    <div class="bg-white rounded-t-xl shadow-sm border-b">
      <div class="flex space-x-8 px-6 overflow-x-auto">
        <button class="tabs-btn py-4 tab-active whitespace-nowrap" data-tab="movimientos">
          <i class="fas fa-exchange-alt mr-2"></i>Movimientos
        </button>
        <button class="tabs-btn py-4 text-gray-600 hover:text-purple-600 whitespace-nowrap" data-tab="gastos">
          <i class="fas fa-receipt mr-2"></i>Gastos Comunes
        </button>
        <button class="tabs-btn py-4 text-gray-600 hover:text-purple-600 whitespace-nowrap" data-tab="arriendos">
          <i class="fas fa-home mr-2"></i>Arriendos
        </button>
        <button class="tabs-btn py-4 text-gray-600 hover:text-purple-600 whitespace-nowrap" data-tab="proveedores">
          <i class="fas fa-tools mr-2"></i>Proveedores
        </button>
        <button class="tabs-btn py-4 text-gray-600 hover:text-purple-600 whitespace-nowrap" data-tab="empleados">
          <i class="fas fa-users mr-2"></i>Empleados
        </button>
        <button class="tabs-btn py-4 text-gray-600 hover:text-purple-600 whitespace-nowrap" data-tab="caja-chica">
          <i class="fas fa-wallet mr-2"></i>Caja Chica
        </button>
        <button class="tabs-btn py-4 text-gray-600 hover:text-purple-600 whitespace-nowrap" data-tab="otros">
          <i class="fas fa-folder mr-2"></i>Otros
        </button>
        <button class="tabs-btn py-4 text-gray-600 hover:text-purple-600 whitespace-nowrap" data-tab="alertas">
          <i class="fas fa-bell mr-2"></i>Alertas
          <span class="ml-1 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">3</span>
        </button>
        <button class="tabs-btn py-4 text-gray-600 hover:text-purple-600 whitespace-nowrap" data-tab="resumen">
          <i class="fas fa-chart-pie mr-2"></i>Resumen Mensual
        </button>
        <button class="tabs-btn py-4 text-gray-600 hover:text-purple-600 whitespace-nowrap" data-tab="actividad">
          <i class="fas fa-history mr-2"></i>Registro Actividad
          <span class="ml-1 bg-purple-500 text-white text-xs px-2 py-0.5 rounded-full">Admin</span>
        </button>
      </div>
    </div>

    <!-- Movimientos -->
    <div id="movimientos-tab" class="bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-list-ul mr-2 text-purple-600"></i>Movimientos Recientes</h2>
        <div class="flex space-x-3">
          <button onclick="openNewMovementModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2.5 rounded-lg font-semibold shadow-md transition duration-200 flex items-center">
            <i class="fas fa-plus mr-2"></i>Nuevo Movimiento
          </button>
          <button id="exportButton" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2.5 rounded-lg font-semibold shadow-md transition duration-200 flex items-center">
            <i class="fas fa-download mr-2"></i>Exportar
            <span class="ml-2 text-xs bg-green-800 px-2 py-0.5 rounded-full">Admin</span>
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">√Årea</label>
          <select id="filterArea" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <option>Todas las √°reas</option>
            <option>Gastos Comunes</option>
            <option>Arriendos</option>
            <option>Proveedores</option>
            <option>Empleados</option>
            <option>Caja Chica</option>
            <option>Otros</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
          <select id="filterTipo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <option>Todos</option>
            <option>Ingreso</option>
            <option>Egreso</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Desde</label>
          <input id="filterDesde" type="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Hasta</label>
          <input id="filterHasta" type="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fecha</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">√Årea</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tipo</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Descripci√≥n</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Monto</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Responsable</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="movimientosBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>

      <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3 mt-6">
        <p id="movimientosInfo" class="text-sm text-gray-600">Mostrando 0-0 de 0 movimientos</p>
        <div id="paginationControls" class="flex flex-wrap gap-2 justify-end"></div>
      </div>
    </div>

    <!-- (tabs restantes sin cambios, los dej√© igual a tu base) -->
    <div id="gastos-tab" class="hidden bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-receipt mr-2 text-purple-600"></i>Gastos Comunes</h2>
        <div class="text-sm text-gray-600">Movimientos: <span id="gastosCount" class="font-semibold">0</span> ¬∑ Total: <span id="gastosTotal" class="font-semibold">$0</span></div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fecha</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tipo</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Descripci√≥n</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Monto</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Responsable</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="gastosBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <div id="arriendos-tab" class="hidden bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-home mr-2 text-purple-600"></i>Arriendos</h2>
        <div class="text-sm text-gray-600">Movimientos: <span id="arriendosCount" class="font-semibold">0</span> ¬∑ Total: <span id="arriendosTotal" class="font-semibold">$0</span></div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fecha</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tipo</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Descripci√≥n</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Monto</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Responsable</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="arriendosBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <div id="proveedores-tab" class="hidden bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-tools mr-2 text-purple-600"></i>Proveedores</h2>
        <div class="text-sm text-gray-600">Movimientos: <span id="proveedoresCount" class="font-semibold">0</span> ¬∑ Total: <span id="proveedoresTotal" class="font-semibold">$0</span></div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fecha</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tipo</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Descripci√≥n</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Monto</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Responsable</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="proveedoresBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <div id="empleados-tab" class="hidden bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-users mr-2 text-purple-600"></i>Empleados</h2>
        <div class="text-sm text-gray-600">Movimientos: <span id="empleadosCount" class="font-semibold">0</span> ¬∑ Total: <span id="empleadosTotal" class="font-semibold">$0</span></div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fecha</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tipo</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Descripci√≥n</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Monto</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Responsable</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="empleadosBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <div id="caja-chica-tab" class="hidden bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-wallet mr-2 text-purple-600"></i>Caja Chica</h2>
        <div class="text-sm text-gray-600">Movimientos: <span id="cajaChicaCount" class="font-semibold">0</span> ¬∑ Neto: <span id="cajaChicaTotal" class="font-semibold">$0</span></div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fecha</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tipo</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Descripci√≥n</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Monto</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Responsable</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="cajaChicaBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <div id="otros-tab" class="hidden bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-folder mr-2 text-purple-600"></i>Otros</h2>
        <div class="text-sm text-gray-600">Movimientos: <span id="otrosCount" class="font-semibold">0</span> ¬∑ Total: <span id="otrosTotal" class="font-semibold">$0</span></div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fecha</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tipo</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Descripci√≥n</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Monto</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Responsable</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="otrosBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <div id="alertas-tab" class="hidden bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-bell mr-2 text-purple-600"></i>Alertas</h2>
        <div class="text-sm text-gray-600">Activas: <span id="alertasCount" class="font-semibold">0</span></div>
      </div>
      <div id="alertasList" class="space-y-3"></div>
      <p class="text-xs text-gray-400 mt-4">*Las alertas se generan desde Movimientos (morosos/pendientes y egresos altos).</p>
    </div>

    <div id="resumen-tab" class="hidden bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-chart-pie mr-2 text-purple-600"></i>Resumen Mensual</h2>
        <div class="text-sm text-gray-600">Mes: <span id="resumenMes" class="font-semibold">‚Äî</span></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="p-4 rounded-lg bg-gray-50 border">
          <div class="text-xs text-gray-500">Ingresos (mes)</div>
          <div id="resumenIngresosMes" class="text-xl font-semibold">$0</div>
        </div>
        <div class="p-4 rounded-lg bg-gray-50 border">
          <div class="text-xs text-gray-500">Egresos (mes)</div>
          <div id="resumenEgresosMes" class="text-xl font-semibold">$0</div>
        </div>
        <div class="p-4 rounded-lg bg-gray-50 border">
          <div class="text-xs text-gray-500">Balance (mes)</div>
          <div id="resumenBalanceMes" class="text-xl font-semibold">$0</div>
        </div>
      </div>

      <h3 class="font-semibold text-gray-700 mb-2">Top √°reas (mes)</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">√Årea</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Ingresos</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Egresos</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Neto</th>
            </tr>
          </thead>
          <tbody id="resumenTopAreas" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <div id="actividad-tab" class="hidden bg-white rounded-b-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-history mr-2 text-purple-600"></i>Registro Actividad</h2>
        <div class="text-sm text-gray-600">Solo Admin ¬∑ √öltimas acciones</div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fecha/Hora</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Usuario</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Acci√≥n</th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Detalle</th>
            </tr>
          </thead>
          <tbody id="actividadBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
      <p class="text-xs text-gray-400 mt-4">*En esta demo se registra en memoria (se reinicia al recargar).</p>
    </div>

  </div>

  <!-- Modal -->
  <div id="newMovementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-overlay flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="gradient-bg text-white p-6 rounded-t-2xl">
        <div class="flex justify-between items-center">
          <div>
            <h3 id="modalTitle" class="text-2xl font-bold">Nuevo Movimiento</h3>
            <p class="text-sm text-purple-200 mt-1">Registra un nuevo movimiento financiero</p>
          </div>
          <button onclick="closeModal()" class="text-white hover:text-gray-200 text-2xl"><i class="fas fa-times"></i></button>
        </div>
      </div>

      <form class="p-6 space-y-4" id="movementForm">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-calendar text-purple-600 mr-2"></i>Fecha del Movimiento</label>
          <input id="mvFecha" type="date" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200" required>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-layer-group text-purple-600 mr-2"></i>√Årea</label>
          <select id="mvArea" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200" required>
            <option value="">Seleccione un √°rea...</option>
            <option value="gastos-comunes">üí° Gastos Comunes</option>
            <option value="arriendos">üè† Arriendos</option>
            <option value="proveedores">üîß Proveedores</option>
            <option value="empleados">üë• Empleados</option>
            <option value="caja-chica">üí∞ Caja Chica</option>
            <option value="otros">üìã Otros</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-exchange-alt text-purple-600 mr-2"></i>Tipo de Movimiento</label>
          <div class="grid grid-cols-2 gap-4">
            <label class="relative">
              <input id="mvTipoIngreso" type="radio" name="tipo" value="ingreso" class="peer sr-only" required>
              <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer peer-checked:border-green-500 peer-checked:bg-green-50 transition duration-200">
                <div class="flex items-center space-x-3">
                  <i class="fas fa-arrow-up text-2xl text-green-600"></i>
                  <div><p class="font-semibold text-gray-800">Ingreso</p><p class="text-xs text-gray-500">Entrada de dinero</p></div>
                </div>
              </div>
            </label>
            <label class="relative">
              <input id="mvTipoEgreso" type="radio" name="tipo" value="egreso" class="peer sr-only" required>
              <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer peer-checked:border-red-500 peer-checked:bg-red-50 transition duration-200">
                <div class="flex items-center space-x-3">
                  <i class="fas fa-arrow-down text-2xl text-red-600"></i>
                  <div><p class="font-semibold text-gray-800">Egreso</p><p class="text-xs text-gray-500">Salida de dinero</p></div>
                </div>
              </div>
            </label>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-dollar-sign text-purple-600 mr-2"></i>Monto</label>
          <div class="relative">
            <span class="absolute left-4 top-3.5 text-gray-500 font-semibold">$</span>
            <input id="mvMonto" type="number" placeholder="0" class="w-full pl-8 pr-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200" required>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-align-left text-purple-600 mr-2"></i>Descripci√≥n</label>
          <textarea id="mvDescripcion" rows="3" placeholder="Ej: Pago arriendo Local 12 - Febrero 2026" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200" required></textarea>
        </div>

        <!-- ‚úÖ DETALLES ADICIONALES (como la foto) -->
        <div class="border border-gray-200 rounded-xl p-5 bg-gray-50">
          <div class="flex items-center gap-2 mb-4">
            <i class="fas fa-circle-info text-purple-600"></i>
            <h4 class="font-semibold text-gray-800">Detalles Adicionales</h4>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- N√∫mero de Local -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-store text-purple-600 mr-2"></i>N√∫mero de Local
              </label>
              <select id="mvNumeroLocal" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                <option value="">Seleccionar local...</option>
                <option>Local 1</option>
                <option>Local 2</option>
                <option>Local 3</option>
                <option>Local 4</option>
                <option>Local 5</option>
              </select>
            </div>

            <!-- Arrendatario/Propietario -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-user text-purple-600 mr-2"></i>Arrendatario/Propietario
              </label>
              <input id="mvArrendatarioPropietario" type="text" placeholder="Ej: Juan P√©rez"
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>

            <!-- Nombre Empleado -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-id-badge text-purple-600 mr-2"></i>Nombre Empleado
              </label>
              <select id="mvNombreEmpleado" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                <option value="">No aplica / Seleccionar...</option>
                <option>Mar√≠a Gonz√°lez</option>
                <option>Pedro Ram√≠rez</option>
                <option>Camila Rojas</option>
              </select>
            </div>

            <!-- Proveedor/Empresa -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-building text-purple-600 mr-2"></i>Proveedor/Empresa
              </label>
              <input id="mvProveedorEmpresa" type="text" placeholder="Ej: Empresa de Limpieza S.A."
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>

            <!-- RUT/Identificaci√≥n -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-id-card text-purple-600 mr-2"></i>RUT/Identificaci√≥n
              </label>
              <input id="mvRutIdentificacion" type="text" placeholder="Ej: 12.345.678-9"
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>

            <!-- M√©todo de Pago -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-credit-card text-purple-600 mr-2"></i>M√©todo de Pago
              </label>
              <select id="mvMetodoPago" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                <option value="">Seleccionar m√©todo...</option>
                <option>Transferencia</option>
                <option>Efectivo</option>
                <option>Tarjeta</option>
                <option>Cheque</option>
                <option>Otro</option>
              </select>
            </div>

            <!-- N¬∞ Comprobante/Boleta -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-receipt text-purple-600 mr-2"></i>N¬∞ Comprobante/Boleta
              </label>
              <input id="mvComprobanteBoleta" type="text" placeholder="Ej: 00123456"
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>

            <!-- Fecha Vencimiento -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-clock text-purple-600 mr-2"></i>Fecha Vencimiento
              </label>
              <input id="mvFechaVencimiento" type="date"
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>

            <!-- Estado de Pago -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-square-check text-green-600 mr-2"></i>Estado de Pago
              </label>
              <select id="mvEstadoPago" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                <option value="">Seleccione...</option>
                <option>Pendiente</option>
                <option>Pagado</option>
                <option>Atrasado</option>
                <option>Anulado</option>
              </select>
            </div>

            <!-- Concepto/Categor√≠a -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-tag text-purple-600 mr-2"></i>Concepto/Categor√≠a
              </label>
              <select id="mvConceptoCategoria" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                <option>Sin especificar</option>
                <option>Arriendo</option>
                <option>Servicios b√°sicos</option>
                <option>Limpieza</option>
                <option>Mantenci√≥n</option>
                <option>Sueldos</option>
                <option>Reparaci√≥n</option>
                <option>Otros</option>
              </select>
            </div>

            <!-- Per√≠odo Correspondiente (como la foto: dentro del bloque) -->
            <div class="md:col-span-1">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-calendar-alt text-purple-600 mr-2"></i>Per√≠odo Correspondiente
              </label>
              <input id="mvPeriodo" type="month"
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>

            <!-- Espacio (para mantener est√©tica en md) -->
            <div class="hidden md:block"></div>

            <!-- Notas Adicionales (full width) -->
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-pen-to-square text-purple-600 mr-2"></i>Notas Adicionales
              </label>
              <textarea id="mvNotasAdicionales" rows="3" placeholder="Informaci√≥n adicional relevante..."
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
            </div>
          </div>
        </div>

        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
          <div class="flex items-center space-x-2">
            <i class="fas fa-user-check text-purple-600"></i>
            <p class="text-sm text-gray-700"><span class="font-semibold">Responsable:</span> <span class="text-purple-600">Admin (asignado autom√°ticamente)</span></p>
          </div>
        </div>

        <div class="flex space-x-3 pt-4">
          <button type="button" onclick="closeModal()" class="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition duration-200">
            <i class="fas fa-times mr-2"></i>Cancelar
          </button>
          <button id="modalSubmitBtn" type="submit" class="flex-1 px-6 py-3 gradient-bg text-white rounded-lg font-semibold hover:shadow-lg transition duration-200">
            <i class="fas fa-save mr-2"></i><span id="modalSubmitText">Guardar Movimiento</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const currentUser = { name: 'Admin', role: 'admin', email: 'admin@anfiteatro.cl' };
    const MOV = { header: [], rows: [], idx: null };
    let EDITING_ID = null;

    const PAGE_SIZE = 5;
    let MOV_PAGE = 1;
    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
    function resetPagination() { MOV_PAGE = 1; }

    const TAB_IDS = ["movimientos","gastos","arriendos","proveedores","empleados","caja-chica","otros","alertas","resumen","actividad"];
    let CURRENT_TAB = "movimientos";

    const ACT_LOG = [];
    function logAction(action, detail) {
      const ts = new Date().toISOString();
      ACT_LOG.unshift({ ts, user: currentUser?.name || "Admin", action, detail: detail || "" });
      if (ACT_LOG.length > 200) ACT_LOG.length = 200;
      renderActividad();
    }

    function renderActividad() {
      const tbody = document.getElementById("actividadBody");
      if (!tbody) return;
      tbody.innerHTML = "";
      (ACT_LOG || []).slice(0, 50).forEach(a => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50 transition duration-150";
        const dt = a.ts ? new Date(a.ts) : null;
        const when = dt && !isNaN(dt) ? dt.toLocaleString("es-CL") : (a.ts || "");
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${when}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${a.user || ""}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-purple-700">${a.action || ""}</td>
          <td class="px-6 py-4 text-sm text-gray-900">${a.detail || ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function showTab(tabName, evOrBtn) {
      const safeTab = TAB_IDS.includes(tabName) ? tabName : "movimientos";
      CURRENT_TAB = safeTab;

      TAB_IDS.forEach(t => document.getElementById(`${t}-tab`)?.classList.add("hidden"));
      document.getElementById(`${safeTab}-tab`)?.classList.remove("hidden");

      document.querySelectorAll(".tabs-btn").forEach(b => { b.classList.remove("tab-active"); b.classList.add("text-gray-600"); });
      const btn = (evOrBtn && evOrBtn.target) ? evOrBtn.target.closest("button") : evOrBtn;
      if (btn) { btn.classList.add("tab-active"); btn.classList.remove("text-gray-600"); }

      if (["gastos","arriendos","proveedores","empleados","caja-chica","otros"].includes(safeTab)) renderAreaTabs();
      if (safeTab === "alertas") renderAlertas();
      if (safeTab === "resumen") renderResumenMensual();
      if (safeTab === "actividad") renderActividad();
    }

    function closeModal() { document.getElementById('newMovementModal').classList.add('hidden'); }

    function openNewMovementModal() {
      EDITING_ID = null;
      document.getElementById('modalTitle').textContent = 'Nuevo Movimiento';
      document.getElementById('modalSubmitText').textContent = 'Guardar Movimiento';
      document.getElementById('movementForm')?.reset();

      const d = new Date();
      const iso = d.toISOString().slice(0,10);
      const ym = iso.slice(0,7);
      document.getElementById('mvFecha').value = iso;
      document.getElementById('mvPeriodo').value = ym;

      // defaults
      document.getElementById("mvEstadoPago").value = "";
      document.getElementById("mvConceptoCategoria").value = "Sin especificar";

      document.getElementById('newMovementModal').classList.remove('hidden');
    }

    
    // API Key (x-api-key) para acceder a Netlify Functions protegidas
    function getApiKey() {
      let k = (localStorage.getItem("ANFITEATRO_API_KEY") || "").trim();
      if (!k) {
        k = (prompt("Ingresa tu API Key para usar el sistema (x-api-key):") || "").trim();
        if (k) localStorage.setItem("ANFITEATRO_API_KEY", k);
      }
      return k;
    }

async function apiFetch(path, options = {}) {
      const apiKey = getApiKey();
      if (!apiKey) throw new Error("Falta API Key (x-api-key). Gu√°rdala en localStorage como ANFITEATRO_API_KEY o ingr√©sala cuando se solicite.");
      const res = await fetch(path, {
        ...options,
        headers: { "Content-Type": "application/json", "x-api-key": apiKey, ...(options.headers || {}) }
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.ok === false) throw new Error(data.error || `HTTP ${res.status}`);
      return data;
    }

    function formatCLP(value) {
      const n = Number(value) || 0;
      return n.toLocaleString("es-CL", { style: "currency", currency: "CLP" });
    }
    function formatFechaISO(iso) {
      if (!iso || typeof iso !== "string") return "";
      const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (!m) return iso;
      return `${m[3]}/${m[2]}/${m[1]}`;
    }
    function norm(s) { return (s ?? "").toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }
    function findCol(header, candidates) {
      const h = (header || []).map(norm);
      for (const c of candidates) { const i = h.indexOf(norm(c)); if (i >= 0) return i; }
      return -1;
    }
    function parseMoney(v) {
      if (v == null) return 0;
      const cleaned = v.toString().trim().replace(/[^\d-]/g, "");
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : 0;
    }
    function setText(id, value) { const el = document.getElementById(id); if (el) el.textContent = value; }
    function monthOfFechaISO(fecha) { const m = (fecha || "").toString().match(/^(\d{4})-(\d{2})-(\d{2})/); return m ? `${m[1]}-${m[2]}` : ""; }

    function buildIdx(header) {
      return {
        id: findCol(header, ["ID"]),
        fecha: findCol(header, ["Fecha"]),
        area: findCol(header, ["√Årea", "Area"]),
        tipo: findCol(header, ["Tipo"]),
        descripcion: findCol(header, ["Descripci√≥n", "Descripcion"]),
        monto: findCol(header, ["Monto", "MontoAsignado", "Monto Asignado", "Monto_Signado", "Monto Signado", "Monto_Asignado"]),
        responsable: findCol(header, ["Responsable"]),
        periodo: findCol(header, ["Periodo", "Per√≠odo", "Per√≠odo Correspondiente", "Periodo Correspondiente"]),
        estadoPago: findCol(header, ["EstadoPago","Estado Pago","Estado de Pago","Estado"]),

        // ‚úÖ Nuevos campos Detalles Adicionales (con varios alias por si cambian t√≠tulos en sheet)
        numeroLocal: findCol(header, ["N√∫mero de Local","Numero de Local","N¬∞ Local","Nro Local","Local"]),
        arrendatarioPropietario: findCol(header, ["Arrendatario/Propietario","Arrendatario","Propietario"]),
        nombreEmpleado: findCol(header, ["Nombre Empleado","Empleado","Nombre del Empleado"]),
        proveedorEmpresa: findCol(header, ["Proveedor/Empresa","Proveedor","Empresa"]),
        rutIdentificacion: findCol(header, ["RUT/Identificaci√≥n","RUT","Rut","Identificaci√≥n","Identificacion"]),
        metodoPago: findCol(header, ["M√©todo de Pago","Metodo de Pago","Medio de Pago","Forma de Pago"]),
        comprobanteBoleta: findCol(header, ["N¬∞ Comprobante/Boleta","Nro Comprobante/Boleta","Comprobante","Boleta","N¬∞ Comprobante","Nro Comprobante"]),
        fechaVencimiento: findCol(header, ["Fecha Vencimiento","Vencimiento","Fecha de Vencimiento"]),
        conceptoCategoria: findCol(header, ["Concepto/Categor√≠a","Concepto","Categor√≠a","Categoria"]),
        notasAdicionales: findCol(header, ["Notas Adicionales","Notas","Observaciones","Detalle Adicional","Detalles Adicionales"])
      };
    }

    function calcStatsFromMovs(header, rows) {
      const iMonto = findCol(header, ["MontoAsignado","Monto Asignado","Monto","Monto_Signado","Monto Signado","Monto_Asignado"]);
      const iTipo  = findCol(header, ["Tipo"]);
      const iFecha = findCol(header, ["Fecha"]);
      const iEstadoPago = findCol(header, ["EstadoPago","Estado Pago","Estado de Pago","Estado"]);
      const iArea  = findCol(header, ["√Årea","Area"]);

      const now = new Date();
      const thisMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;

      let ingresosMes=0, egresosMes=0, ingresosTotal=0, egresosTotal=0, morosos=0, cajaChica=0;

      for (const r of (rows || [])) {
        const fecha = iFecha>=0 ? (r[iFecha]||"") : "";
        const tipo  = iTipo>=0 ? (r[iTipo]||"") : "";
        const area  = iArea>=0 ? (r[iArea]||"") : "";
        const tipoN = norm(tipo);
        const areaN = norm(area);
        const estadoPago = iEstadoPago>=0 ? (r[iEstadoPago]||"") : "";
        const monto = parseMoney(iMonto>=0 ? r[iMonto] : 0);

        const isIngreso = (tipoN==="ingreso") || (tipoN==="" && monto>0);
        const isEgreso  = (tipoN==="egreso")  || (tipoN==="" && monto<0);

        if (isIngreso) ingresosTotal += Math.abs(monto);
        if (isEgreso)  egresosTotal  += Math.abs(monto);

        if (monthOfFechaISO(fecha) === thisMonth) {
          if (isIngreso) ingresosMes += Math.abs(monto);
          if (isEgreso)  egresosMes  += Math.abs(monto);
        }

        if (estadoPago) {
          const e = estadoPago.toString().toLowerCase();
          if (e.includes("atras") || e.includes("moro") || e.includes("pend")) morosos++;
        }

        const isCajaChica = areaN==="caja chica" || areaN==="caja-chica" || areaN==="cajachica";
        if (isCajaChica) {
          if (isIngreso) cajaChica += Math.abs(monto);
          if (isEgreso)  cajaChica -= Math.abs(monto);
        }
      }

      return { ingresosMes, egresosMes, ingresosTotal, egresosTotal, balanceTotal: ingresosTotal-egresosTotal, morosos, cajaChica };
    }

    function updateCards(header, rows) {
      const s = calcStatsFromMovs(header, rows);
      setText("cardIngresosMes", formatCLP(s.ingresosMes));
      setText("cardEgresosMes", formatCLP(s.egresosMes));
      setText("cardIngresosTotal", formatCLP(s.ingresosTotal));
      setText("cardEgresosTotal", formatCLP(s.egresosTotal));
      setText("cardBalanceTotal", formatCLP(s.balanceTotal));
      setText("cardMorosos", String(s.morosos));
      setText("cardCajaChica", formatCLP(s.cajaChica));
    }

    function readModalFields() {
      const fecha = document.getElementById("mvFecha")?.value?.trim() || "";
      const areaRaw = document.getElementById("mvArea")?.value?.trim() || "";
      const tipoRaw = document.querySelector('#movementForm input[name="tipo"]:checked')?.value?.trim() || "";
      const descripcion = document.getElementById("mvDescripcion")?.value?.trim() || "";
      const monto = Number(document.getElementById("mvMonto")?.value || 0) || 0;

      // ‚úÖ Detalles adicionales
      const numeroLocal = document.getElementById("mvNumeroLocal")?.value?.trim() || "";
      const arrendatarioPropietario = document.getElementById("mvArrendatarioPropietario")?.value?.trim() || "";
      const nombreEmpleado = document.getElementById("mvNombreEmpleado")?.value?.trim() || "";
      const proveedorEmpresa = document.getElementById("mvProveedorEmpresa")?.value?.trim() || "";
      const rutIdentificacion = document.getElementById("mvRutIdentificacion")?.value?.trim() || "";
      const metodoPago = document.getElementById("mvMetodoPago")?.value?.trim() || "";
      const comprobanteBoleta = document.getElementById("mvComprobanteBoleta")?.value?.trim() || "";
      const fechaVencimiento = document.getElementById("mvFechaVencimiento")?.value?.trim() || "";
      const estadoPago = document.getElementById("mvEstadoPago")?.value?.trim() || "";
      const conceptoCategoria = document.getElementById("mvConceptoCategoria")?.value?.trim() || "Sin especificar";
      const periodo = document.getElementById("mvPeriodo")?.value?.trim() || "";
      const notasAdicionales = document.getElementById("mvNotasAdicionales")?.value?.trim() || "";

      const AREA_MAP = {
        "gastos-comunes": "Gastos Comunes",
        "arriendos": "Arriendos",
        "proveedores": "Proveedores",
        "empleados": "Empleados",
        "caja-chica": "Caja Chica",
        "otros": "Otros"
      };
      const area = AREA_MAP[areaRaw] || areaRaw;
      const tipo = (tipoRaw === "ingreso" ? "Ingreso" : tipoRaw === "egreso" ? "Egreso" : tipoRaw);

      if (!fecha || !area || !tipo || !descripcion) {
        throw new Error(`Faltan campos requeridos (fecha, area, tipo, descripcion).`);
      }

      return {
        fecha, area, tipo, descripcion, monto,
        responsable: currentUser?.name || "Admin",

        // detalles
        numeroLocal,
        arrendatarioPropietario,
        nombreEmpleado,
        proveedorEmpresa,
        rutIdentificacion,
        metodoPago,
        comprobanteBoleta,
        fechaVencimiento,
        estadoPago,
        conceptoCategoria,
        periodo,
        notasAdicionales
      };
    }

    async function saveMovement(event) {
      event.preventDefault();
      try {
        const payload = readModalFields();

        if (EDITING_ID) {
          payload.id = EDITING_ID;
          const result = await apiFetch(`/.netlify/functions/movimientos`, {
            method: "PUT",
            body: JSON.stringify(payload)
          });
          alert(`‚úÖ Movimiento editado!\nID: ${result.id || EDITING_ID}`);
          logAction("Editar", `${payload.area} ¬∑ ${payload.tipo} ¬∑ ${formatCLP(payload.monto)} ¬∑ ${payload.descripcion} ¬∑ ${payload.estadoPago || "Sin estado"}`);
        } else {
          const result = await apiFetch("/.netlify/functions/movimientos", {
            method: "POST",
            body: JSON.stringify(payload)
          });
          alert(`‚úÖ Movimiento guardado!\nID: ${result.id}`);
          logAction("Crear", `${payload.area} ¬∑ ${payload.tipo} ¬∑ ${formatCLP(payload.monto)} ¬∑ ${payload.descripcion} ¬∑ ${payload.estadoPago || "Sin estado"}`);
        }

        closeModal();
        resetPagination();
        await loadMovimientos();
      } catch (err) {
        alert("‚ùå Error guardando: " + err.message);
        console.error(err);
      }
    }

    function getFilters() {
      return {
        area: document.getElementById("filterArea")?.value || "Todas las √°reas",
        tipo: document.getElementById("filterTipo")?.value || "Todos",
        desde: document.getElementById("filterDesde")?.value || "",
        hasta: document.getElementById("filterHasta")?.value || ""
      };
    }

    function setMovimientosInfo(start, end, total) {
      const info = document.getElementById("movimientosInfo");
      if (!info) return;
      if (total === 0) info.textContent = "Mostrando 0-0 de 0 movimientos";
      else info.textContent = `Mostrando ${start}-${end} de ${total} movimientos`;
    }

    function renderPaginationControls(totalPages) {
      const container = document.getElementById("paginationControls");
      if (!container) return;
      container.innerHTML = "";
      if (totalPages <= 1) return;

      const btnBase = "px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-50 transition";
      const btnDisabled = "opacity-50 cursor-not-allowed";
      const btnActive = "px-4 py-2 bg-purple-600 text-white rounded-lg";

      const makeBtn = (label, onClick, disabled=false, active=false) => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = active ? btnActive : btnBase;
        b.textContent = label;
        if (disabled) {
          b.classList.add(...btnDisabled.split(" "));
          b.disabled = true;
        } else {
          b.addEventListener("click", onClick);
        }
        return b;
      };

      container.appendChild(makeBtn("Anterior", () => { MOV_PAGE = clamp(MOV_PAGE - 1, 1, totalPages); applyFiltersAndRender(); }, MOV_PAGE === 1));

      const windowSize = 5;
      let start = Math.max(1, MOV_PAGE - Math.floor(windowSize/2));
      let end = Math.min(totalPages, start + windowSize - 1);
      start = Math.max(1, end - windowSize + 1);

      for (let p = start; p <= end; p++) {
        container.appendChild(makeBtn(String(p), () => { MOV_PAGE = p; applyFiltersAndRender(); }, false, p === MOV_PAGE));
      }

      container.appendChild(makeBtn("Siguiente", () => { MOV_PAGE = clamp(MOV_PAGE + 1, 1, totalPages); applyFiltersAndRender(); }, MOV_PAGE === totalPages));
    }

    function renderMovRowsPage(rows) {
      const tbody = document.getElementById("movimientosBody");
      if (!tbody) return;
      tbody.innerHTML = "";

      (rows || []).forEach(r => {
        const id = MOV.idx.id >= 0 ? (r[MOV.idx.id] || "") : "";
        const fecha = MOV.idx.fecha >= 0 ? r[MOV.idx.fecha] : "";
        const area = MOV.idx.area >= 0 ? r[MOV.idx.area] : "";
        const tipo = MOV.idx.tipo >= 0 ? r[MOV.idx.tipo] : "";
        const descripcion = MOV.idx.descripcion >= 0 ? r[MOV.idx.descripcion] : "";
        const monto = MOV.idx.monto >= 0 ? parseMoney(r[MOV.idx.monto]) : 0;
        const responsable = MOV.idx.responsable >= 0 ? r[MOV.idx.responsable] : "";

        const tipoBadge =
          tipo === "Ingreso"
            ? `<span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800"><i class="fas fa-arrow-up mr-1"></i>Ingreso</span>`
            : `<span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800"><i class="fas fa-arrow-down mr-1"></i>Egreso</span>`;

        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50 transition duration-150";
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatFechaISO(fecha)}</td>
          <td class="px-6 py-4 whitespace-nowrap"><span class="px-3 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">${area || ""}</span></td>
          <td class="px-6 py-4 whitespace-nowrap">${tipoBadge}</td>
          <td class="px-6 py-4 text-sm text-gray-900">${descripcion || ""}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${tipo === "Ingreso" ? "text-green-600" : "text-red-600"}">
            ${tipo === "Egreso" ? "-" : ""}${formatCLP(monto).replace("-", "")}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600"><i class="fas fa-user-circle mr-1"></i>${responsable || ""}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <button class="text-purple-600 hover:text-purple-900 mr-3" data-action="edit" data-id="${id}" title="Editar"><i class="fas fa-edit"></i></button>
            <button class="text-red-600 hover:text-red-900" data-action="delete" data-id="${id}" title="Eliminar"><i class="fas fa-trash"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function applyFiltersAndRender() {
      const tbody = document.getElementById("movimientosBody");
      if (!tbody || !MOV.idx) return;

      const { area, tipo, desde, hasta } = getFilters();
      let filtered = MOV.rows.slice();

      if (area !== "Todas las √°reas") filtered = filtered.filter(r => (r[MOV.idx.area] || "") === area);
      if (tipo !== "Todos") filtered = filtered.filter(r => (r[MOV.idx.tipo] || "") === tipo);
      if (desde) filtered = filtered.filter(r => (r[MOV.idx.fecha] || "") >= desde);
      if (hasta) filtered = filtered.filter(r => (r[MOV.idx.fecha] || "") <= hasta);

      const ordered = filtered.slice().reverse();

      const total = ordered.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      MOV_PAGE = clamp(MOV_PAGE, 1, totalPages);

      const startIdx = (MOV_PAGE - 1) * PAGE_SIZE;
      const endIdx = Math.min(startIdx + PAGE_SIZE, total);
      const pageRows = ordered.slice(startIdx, endIdx);

      renderMovRowsPage(pageRows);
      setMovimientosInfo(total === 0 ? 0 : startIdx + 1, endIdx, total);
      renderPaginationControls(totalPages);
    }

    function signedAmount(tipo, monto) {
      const t = (tipo || "").toString().trim();
      const m = Math.abs(Number(monto) || 0);
      if (t === "Egreso") return -m;
      if (t === "Ingreso") return m;
      return Number(monto) || 0;
    }

    function filterRowsByArea(areaName) {
      if (!MOV.idx || MOV.idx.area < 0) return [];
      return (MOV.rows || []).filter(r => (r[MOV.idx.area] || "") === areaName);
    }

    function calcCountAndTotal(rows) {
      let total = 0;
      for (const r of (rows || [])) {
        const tipo = MOV.idx?.tipo >= 0 ? (r[MOV.idx.tipo] || "") : "";
        const monto = MOV.idx?.monto >= 0 ? parseMoney(r[MOV.idx.monto]) : 0;
        total += signedAmount(tipo, monto);
      }
      return { count: (rows || []).length, total };
    }

    function renderMovRowsInto(tbodyId, rows) {
      const tbody = document.getElementById(tbodyId);
      if (!tbody) return;
      tbody.innerHTML = "";

      const lastRows = (rows || []).slice().reverse().slice(0, 20);
      lastRows.forEach(r => {
        const id = MOV.idx.id >= 0 ? (r[MOV.idx.id] || "") : "";
        const fecha = MOV.idx.fecha >= 0 ? (r[MOV.idx.fecha] || "") : "";
        const tipo = MOV.idx.tipo >= 0 ? (r[MOV.idx.tipo] || "") : "";
        const descripcion = MOV.idx.descripcion >= 0 ? (r[MOV.idx.descripcion] || "") : "";
        const monto = MOV.idx.monto >= 0 ? parseMoney(r[MOV.idx.monto]) : 0;
        const responsable = MOV.idx.responsable >= 0 ? (r[MOV.idx.responsable] || "") : "";

        const tipoBadge =
          tipo === "Ingreso"
            ? `<span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800"><i class="fas fa-arrow-up mr-1"></i>Ingreso</span>`
            : `<span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800"><i class="fas fa-arrow-down mr-1"></i>Egreso</span>`;

        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50 transition duration-150";
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatFechaISO(fecha)}</td>
          <td class="px-6 py-4 whitespace-nowrap">${tipoBadge}</td>
          <td class="px-6 py-4 text-sm text-gray-900">${descripcion}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${tipo === "Ingreso" ? "text-green-600" : "text-red-600"}">
            ${tipo === "Egreso" ? "-" : ""}${formatCLP(monto).replace("-", "")}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600"><i class="fas fa-user-circle mr-1"></i>${responsable}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <button class="text-purple-600 hover:text-purple-900 mr-3" data-action="edit" data-id="${id}" title="Editar"><i class="fas fa-edit"></i></button>
            <button class="text-red-600 hover:text-red-900" data-action="delete" data-id="${id}" title="Eliminar"><i class="fas fa-trash"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderAreaTabs() {
      const gastos = filterRowsByArea("Gastos Comunes");
      const g = calcCountAndTotal(gastos);
      setText("gastosCount", String(g.count));
      setText("gastosTotal", formatCLP(g.total));
      renderMovRowsInto("gastosBody", gastos);

      const ar = filterRowsByArea("Arriendos");
      const a = calcCountAndTotal(ar);
      setText("arriendosCount", String(a.count));
      setText("arriendosTotal", formatCLP(a.total));
      renderMovRowsInto("arriendosBody", ar);

      const pr = filterRowsByArea("Proveedores");
      const p = calcCountAndTotal(pr);
      setText("proveedoresCount", String(p.count));
      setText("proveedoresTotal", formatCLP(p.total));
      renderMovRowsInto("proveedoresBody", pr);

      const em = filterRowsByArea("Empleados");
      const e = calcCountAndTotal(em);
      setText("empleadosCount", String(e.count));
      setText("empleadosTotal", formatCLP(e.total));
      renderMovRowsInto("empleadosBody", em);

      const cc = filterRowsByArea("Caja Chica");
      const c = calcCountAndTotal(cc);
      setText("cajaChicaCount", String(c.count));
      setText("cajaChicaTotal", formatCLP(c.total));
      renderMovRowsInto("cajaChicaBody", cc);

      const ot = filterRowsByArea("Otros");
      const o = calcCountAndTotal(ot);
      setText("otrosCount", String(o.count));
      setText("otrosTotal", formatCLP(o.total));
      renderMovRowsInto("otrosBody", ot);
    }

    function renderAlertas() {
      const list = document.getElementById("alertasList");
      if (!list) return;

      const iEstado = findCol(MOV.header, ["EstadoPago","Estado Pago","Estado de Pago","Estado"]);
      const iFecha = MOV.idx?.fecha ?? -1;
      const iDesc  = MOV.idx?.descripcion ?? -1;
      const iTipo  = MOV.idx?.tipo ?? -1;
      const iMonto = MOV.idx?.monto ?? -1;
      const iArea  = MOV.idx?.area ?? -1;

      const alerts = [];

      if (iEstado >= 0) {
        for (const r of (MOV.rows || [])) {
          const estado = (r[iEstado] || "").toString().toLowerCase();
          if (estado.includes("pend") || estado.includes("atras") || estado.includes("moro")) {
            alerts.push({
              kind: "warn",
              title: "Pago pendiente/atrasado",
              text: `${formatFechaISO(r[iFecha] || "")} ¬∑ ${(r[iArea] || "")} ¬∑ ${(r[iDesc] || "")}`
            });
          }
        }
      }

      const TH = 200000;
      for (const r of (MOV.rows || [])) {
        const tipo = iTipo >= 0 ? (r[iTipo] || "") : "";
        const monto = iMonto >= 0 ? Math.abs(parseMoney(r[iMonto])) : 0;
        if (tipo === "Egreso" && monto >= TH) {
          alerts.push({
            kind: "danger",
            title: "Egreso alto",
            text: `${formatFechaISO(r[iFecha] || "")} ¬∑ ${(r[iArea] || "")} ¬∑ ${formatCLP(monto)} ¬∑ ${(r[iDesc] || "")}`
          });
        }
      }

      list.innerHTML = "";
      const shown = alerts.slice(0, 10);
      setText("alertasCount", String(shown.length));

      if (shown.length === 0) {
        list.innerHTML = `<div class="p-4 rounded-lg bg-green-50 border border-green-200 text-green-800">
          <i class="fas fa-check-circle mr-2"></i>No hay alertas por ahora.
        </div>`;
        return;
      }

      shown.forEach(a => {
        const cls = a.kind === "danger"
          ? "bg-red-50 border-red-200 text-red-800"
          : "bg-yellow-50 border-yellow-200 text-yellow-800";
        const icon = a.kind === "danger" ? "fa-triangle-exclamation" : "fa-circle-exclamation";
        const div = document.createElement("div");
        div.className = `p-4 rounded-lg border ${cls}`;
        div.innerHTML = `<div class="font-semibold"><i class="fas ${icon} mr-2"></i>${a.title}</div><div class="text-sm mt-1">${a.text}</div>`;
        list.appendChild(div);
      });
    }

    function renderResumenMensual() {
      const now = new Date();
      const thisMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
      setText("resumenMes", thisMonth);

      const iFecha = MOV.idx?.fecha ?? -1;
      const iArea  = MOV.idx?.area ?? -1;
      const iTipo  = MOV.idx?.tipo ?? -1;
      const iMonto = MOV.idx?.monto ?? -1;

      const monthRows = (MOV.rows || []).filter(r => {
        const f = iFecha >= 0 ? (r[iFecha] || "") : "";
        return monthOfFechaISO(f) === thisMonth;
      });

      let ing = 0, egr = 0;
      const byArea = new Map();

      for (const r of monthRows) {
        const area = iArea >= 0 ? (r[iArea] || "Sin √°rea") : "Sin √°rea";
        const tipo = iTipo >= 0 ? (r[iTipo] || "") : "";
        const monto = iMonto >= 0 ? Math.abs(parseMoney(r[iMonto])) : 0;

        const obj = byArea.get(area) || { ing: 0, egr: 0 };
        if (tipo === "Ingreso") { ing += monto; obj.ing += monto; }
        if (tipo === "Egreso")  { egr += monto; obj.egr += monto; }
        byArea.set(area, obj);
      }

      setText("resumenIngresosMes", formatCLP(ing));
      setText("resumenEgresosMes", formatCLP(egr));
      setText("resumenBalanceMes", formatCLP(ing - egr));

      const tbody = document.getElementById("resumenTopAreas");
      if (!tbody) return;
      tbody.innerHTML = "";

      const entries = Array.from(byArea.entries())
        .map(([area, v]) => ({ area, ...v, neto: v.ing - v.egr }))
        .sort((a,b) => Math.abs(b.neto) - Math.abs(a.neto))
        .slice(0, 10);

      if (entries.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="px-6 py-4 text-sm text-gray-500" colspan="4">No hay movimientos en este mes.</td>`;
        tbody.appendChild(tr);
        return;
      }

      entries.forEach(x => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50 transition duration-150";
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${x.area}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-green-700 font-semibold">${formatCLP(x.ing)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-red-700 font-semibold">${formatCLP(x.egr)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${x.neto >= 0 ? "text-green-700" : "text-red-700"}">${formatCLP(x.neto)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function openEditModalById(id) {
      if (!id) return;
      const idx = MOV.idx;
      const row = MOV.rows.find(r => (idx.id >= 0 ? (r[idx.id] || "") : "") === id);
      if (!row) return alert("No encontr√© el movimiento en cache: " + id);

      EDITING_ID = id;
      document.getElementById('modalTitle').textContent = 'Editar Movimiento';
      document.getElementById('modalSubmitText').textContent = 'Guardar Cambios';

      const fecha = idx.fecha >= 0 ? (row[idx.fecha] || "") : "";
      const area = idx.area >= 0 ? (row[idx.area] || "") : "";
      const tipo = idx.tipo >= 0 ? (row[idx.tipo] || "") : "";
      const descripcion = idx.descripcion >= 0 ? (row[idx.descripcion] || "") : "";
      const monto = idx.monto >= 0 ? parseMoney(row[idx.monto]) : 0;

      document.getElementById("mvFecha").value = fecha;

      const AREA_REV = {
        "Gastos Comunes": "gastos-comunes",
        "Arriendos": "arriendos",
        "Proveedores": "proveedores",
        "Empleados": "empleados",
        "Caja Chica": "caja-chica",
        "Otros": "otros"
      };
      document.getElementById("mvArea").value = AREA_REV[area] || "";

      document.getElementById("mvTipoIngreso").checked = false;
      document.getElementById("mvTipoEgreso").checked = false;
      if (tipo === "Ingreso") document.getElementById("mvTipoIngreso").checked = true;
      if (tipo === "Egreso") document.getElementById("mvTipoEgreso").checked = true;

      document.getElementById("mvDescripcion").value = descripcion;
      document.getElementById("mvMonto").value = Math.abs(monto);

      // ‚úÖ Cargar Detalles Adicionales desde sheet si existen columnas
      document.getElementById("mvPeriodo").value = (idx.periodo >= 0 ? (row[idx.periodo] || "") : "");
      document.getElementById("mvEstadoPago").value = (idx.estadoPago >= 0 ? (row[idx.estadoPago] || "") : "");

      document.getElementById("mvNumeroLocal").value = (idx.numeroLocal >= 0 ? (row[idx.numeroLocal] || "") : "");
      document.getElementById("mvArrendatarioPropietario").value = (idx.arrendatarioPropietario >= 0 ? (row[idx.arrendatarioPropietario] || "") : "");
      document.getElementById("mvNombreEmpleado").value = (idx.nombreEmpleado >= 0 ? (row[idx.nombreEmpleado] || "") : "");
      document.getElementById("mvProveedorEmpresa").value = (idx.proveedorEmpresa >= 0 ? (row[idx.proveedorEmpresa] || "") : "");
      document.getElementById("mvRutIdentificacion").value = (idx.rutIdentificacion >= 0 ? (row[idx.rutIdentificacion] || "") : "");
      document.getElementById("mvMetodoPago").value = (idx.metodoPago >= 0 ? (row[idx.metodoPago] || "") : "");
      document.getElementById("mvComprobanteBoleta").value = (idx.comprobanteBoleta >= 0 ? (row[idx.comprobanteBoleta] || "") : "");
      document.getElementById("mvFechaVencimiento").value = (idx.fechaVencimiento >= 0 ? (row[idx.fechaVencimiento] || "") : "");
      document.getElementById("mvConceptoCategoria").value = (idx.conceptoCategoria >= 0 ? (row[idx.conceptoCategoria] || "Sin especificar") : "Sin especificar");
      document.getElementById("mvNotasAdicionales").value = (idx.notasAdicionales >= 0 ? (row[idx.notasAdicionales] || "") : "");

      document.getElementById('newMovementModal').classList.remove('hidden');
    }

    async function deleteMovimientoById(id) {
      if (!id) return;
      if (!confirm(`¬øEliminar movimiento?\nID: ${id}`)) return;
      try {
        await apiFetch(`/.netlify/functions/movimientos?id=${encodeURIComponent(id)}`, { method: "DELETE" });
        alert("‚úÖ Eliminado: " + id);
        logAction("Eliminar", `ID: ${id}`);
        resetPagination();
        await loadMovimientos();
      } catch (e) {
        alert("‚ùå No pude eliminar: " + e.message);
      }
    }

    async function loadMovimientos() {
      const data = await apiFetch("/.netlify/functions/movimientos");
      MOV.header = data.header || [];
      MOV.rows = data.rows || [];
      MOV.idx = buildIdx(MOV.header);

      updateCards(MOV.header, MOV.rows);
      applyFiltersAndRender();
      renderAreaTabs();

      if (CURRENT_TAB === "alertas") renderAlertas();
      if (CURRENT_TAB === "resumen") renderResumenMensual();
      if (CURRENT_TAB === "actividad") renderActividad();
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll(".tabs-btn[data-tab]").forEach(btn => {
        btn.addEventListener("click", () => showTab(btn.dataset.tab, btn));
      });

      const firstTabBtn = document.querySelector('.tabs-btn[data-tab="movimientos"]');
      showTab("movimientos", firstTabBtn);

      document.getElementById("movementForm")?.addEventListener("submit", saveMovement);
      loadMovimientos().catch(console.error);

      ["filterArea","filterTipo","filterDesde","filterHasta"].forEach(id => {
        document.getElementById(id)?.addEventListener("change", () => {
          resetPagination();
          applyFiltersAndRender();
        });
      });

      document.body.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;
        const action = btn.dataset.action;
        const id = btn.dataset.id;
        if (action === "edit") openEditModalById(id);
        if (action === "delete") deleteMovimientoById(id);
      });

      const exportButton = document.getElementById("exportButton");
      if (exportButton) {
        if (currentUser.role !== "admin") {
          exportButton.classList.add("opacity-50", "cursor-not-allowed");
          exportButton.onclick = (e) => { e.preventDefault(); alert("‚õî Solo el Administrador puede exportar datos del sistema"); };
        } else {
          exportButton.onclick = () => { alert("‚úÖ Exportando datos completos del sistema...\n\nFormatos disponibles:\n‚Ä¢ Excel (.xlsx)\n‚Ä¢ CSV\n‚Ä¢ PDF\n‚Ä¢ JSON"); };
        }
      }

      const modal = document.getElementById('newMovementModal');
      if (modal) modal.addEventListener('click', function(e) { if (e.target === this) closeModal(); });

      // inicializa modal con fecha/periodo de hoy
      const d = new Date();
      const iso = d.toISOString().slice(0,10);
      const ym = iso.slice(0,7);
      document.getElementById('mvFecha').value = iso;
      document.getElementById('mvPeriodo').value = ym;
    });
  </script>
</body>
</html>


